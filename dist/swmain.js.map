{"version":3,"file":"swmain.js","sourceRoot":"","sources":["../src/swmain.ts"],"names":[],"mappings":"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","sourcesContent":["import { Collection, type Prefixes } from \"./collection\";\nimport { WorkerLoader } from \"./loaders\";\n\nimport {\n  addProxyAllowPaths,\n  getCSP,\n  isAjaxRequest,\n  proxyAllowPaths,\n  updateCSP,\n} from \"./utils\";\nimport { StatsTracker } from \"./statstracker\";\n\nimport { API } from \"./api\";\n\nimport WOMBAT from \"../dist-wombat/wombat.txt\";\nimport WOMBAT_WORKERS from \"../dist-wombat/wombatWorkers.txt\";\nimport WOMBAT_PROXY from \"../dist-wombat/wombatProxy.txt\";\n\nimport {\n  ArchiveRequest,\n  resolveFullUrlFromReferrer,\n  type ArchiveRequestInitOpts,\n} from \"./request\";\nimport { type ExtraConfig, type CollMetadata } from \"./types\";\nimport { notFound } from \"./notfound\";\n\nconst CACHE_PREFIX = \"wabac-\";\nconst IS_AJAX_HEADER = \"x-wabac-is-ajax-req\";\n\ndeclare let self: ServiceWorkerGlobalScope;\n\n// ===========================================================================\nexport class SWCollections extends WorkerLoader {\n  prefixes: Prefixes;\n  colls: Record<string, Collection>;\n  inited: Promise<boolean> | null;\n\n  override root: string | null;\n\n  defaultConfig: ExtraConfig;\n\n  constructor(\n    prefixes: Prefixes,\n    root: string | null = null,\n    defaultConfig: ExtraConfig = {},\n  ) {\n    super(self);\n    this.prefixes = prefixes;\n    this.colls = {};\n    this.inited = null;\n    this.root = root;\n    this.defaultConfig = defaultConfig;\n\n    this._fileHandles = {};\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  override _createCollection(opts: Record<string, any>): Collection {\n    return new Collection(opts, this.prefixes, this.defaultConfig);\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  override async loadAll(dbColl?: any): Promise<boolean> {\n    this.colls = {};\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    this.inited = super.loadAll(dbColl);\n    return this.inited;\n  }\n\n  async getColl(name: string) {\n    if (!this.colls[name]) {\n      this.colls[name] = await this.loadColl(name);\n    }\n    return this.colls[name];\n  }\n\n  override async reload(name: string) {\n    delete this.colls[name];\n\n    await this.getColl(name);\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  override async addCollection(data: any, progressUpdate: any) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    const opts = await super.addCollection(data, progressUpdate);\n\n    if (opts && opts.name) {\n      // if name matches root collection, mark as root\n      if (this.root === opts.name) {\n        opts.config.root = true;\n      }\n      this.colls[opts.name] = this._createCollection(opts);\n    }\n\n    return opts;\n  }\n\n  override async deleteColl(name: string, keepFileHandle = false) {\n    if (this.colls[name]) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n      if (this.colls[name].store) {\n        await this.colls[name].store.delete();\n      }\n\n      if (\n        this._fileHandles &&\n        keepFileHandle &&\n        this.colls[name].config.extra?.fileHandle\n      ) {\n        this._fileHandles[this.colls[name].config.sourceUrl] =\n          this.colls[name].config.extra.fileHandle;\n      }\n    }\n\n    if (!(await super.deleteColl(name))) {\n      return false;\n    }\n    delete this.colls[name];\n    return true;\n  }\n\n  override async initNewColl(\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    metadata: any,\n    extraConfig = {},\n    type = \"archive\",\n  ) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    const coll = await super.initNewColl(metadata, extraConfig, type);\n    if (coll) {\n      this.colls[coll.name] = coll;\n    }\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return coll;\n  }\n\n  override async updateAuth(name: string, headers: Record<string, string>) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    if (this.colls[name] && (this.colls[name].store as any).updateHeaders) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (this.colls[name].store as any).updateHeaders(headers);\n    }\n\n    return await super.updateAuth(name, headers);\n  }\n\n  override async updateMetadata(name: string, newMetadata: CollMetadata) {\n    const metadata = await super.updateMetadata(name, newMetadata);\n    if (this.colls[name] && metadata) {\n      this.colls[name].config.metadata = metadata;\n      this.colls[name].metadata = metadata;\n    }\n    return metadata;\n  }\n\n  override async updateSize(\n    name: string,\n    fullSize: number,\n    dedupSize: number,\n    updateDecode?: boolean,\n  ) {\n    const metadata = await super.updateSize(\n      name,\n      fullSize,\n      dedupSize,\n      updateDecode,\n    );\n    if (this.colls[name] && metadata) {\n      this.colls[name].config.metadata = metadata;\n      this.colls[name].metadata = metadata;\n    }\n    if (updateDecode !== undefined && this.colls[name]) {\n      this.colls[name].config.decode = updateDecode;\n    }\n    return metadata;\n  }\n}\n\ntype SWReplayInitOpts = {\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  staticData?: Map<string, any> | null;\n  ApiClass?: typeof API;\n  defaultConfig?: ExtraConfig;\n  CollectionsClass?: typeof SWCollections;\n};\n\n// ===========================================================================\nexport class SWReplay {\n  prefix: string;\n  replayPrefix: string;\n  staticPrefix: string;\n  distPrefix: string;\n  proxyPrefix: string;\n\n  staticData: Map<string, { type: string; content: string }>;\n\n  collections: SWCollections;\n\n  proxyOriginMode: boolean;\n\n  api: API;\n  apiPrefix: string;\n\n  allowRewrittenCache: boolean;\n  topFramePassthrough = false;\n\n  stats: StatsTracker | null;\n\n  constructor({\n    staticData = null,\n    ApiClass = API,\n    defaultConfig = {},\n    CollectionsClass = SWCollections,\n  }: SWReplayInitOpts = {}) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    this.prefix = self.registration ? self.registration.scope : \"\";\n\n    const sp = new URLSearchParams(self.location.search);\n\n    this.proxyOriginMode = !!sp.get(\"proxyOriginMode\");\n\n    if (this.proxyOriginMode) {\n      this.replayPrefix = this.prefix + \"__wb_proxy/\";\n      this.staticPrefix = this.replayPrefix + \"static/\";\n      this.proxyPrefix = \"https://wab.ac/proxy/\";\n      this.apiPrefix = \"https://wab.ac/api/\";\n    } else {\n      const suffix = sp.get(\"replayPrefix\") ?? \"w\";\n      this.topFramePassthrough = !suffix;\n      this.replayPrefix = this.prefix + suffix + (suffix ? \"/\" : \"\");\n      this.staticPrefix = this.prefix + \"static/\";\n      this.proxyPrefix = this.staticPrefix + \"proxy/\";\n      this.apiPrefix = this.replayPrefix + \"api/\";\n    }\n\n    updateCSP(this.replayPrefix);\n\n    this.distPrefix = this.prefix + \"dist/\";\n\n    this.staticData = staticData || new Map();\n    this.staticData.set(this.staticPrefix + \"wombat.js\", {\n      type: \"application/javascript\",\n      content: WOMBAT,\n    });\n    this.staticData.set(this.staticPrefix + \"wombatWorkers.js\", {\n      type: \"application/javascript\",\n      content: WOMBAT_WORKERS,\n    });\n    this.staticData.set(this.staticPrefix + \"wombatProxy.js\", {\n      type: \"application/javascript\",\n      content: WOMBAT_PROXY,\n    });\n\n    if (sp.has(\"serveIndex\")) {\n      const indexData = { type: \"text/html\", content: this.getIndexHtml(sp) };\n      this.staticData.set(this.prefix, indexData);\n      this.staticData.set(this.prefix + \"index.html\", indexData);\n    }\n\n    if (sp.has(\"injectScripts\")) {\n      const injectScripts = sp.get(\"injectScripts\")!.split(\",\");\n      defaultConfig.injectScripts = defaultConfig.injectScripts\n        ? [...injectScripts, ...defaultConfig.injectScripts]\n        : injectScripts;\n    }\n\n    if (defaultConfig.injectScripts) {\n      addProxyAllowPaths(defaultConfig.injectScripts);\n    }\n\n    if (sp.has(\"allowProxyPaths\")) {\n      addProxyAllowPaths(sp.get(\"allowProxyPaths\")!.split(\",\"));\n    }\n\n    if (sp.has(\"adblockUrl\")) {\n      defaultConfig.adblockUrl = sp.get(\"adblockUrl\") || \"\";\n    }\n\n    const prefixes: Prefixes = {\n      static: this.staticPrefix,\n      root: this.prefix,\n      main: this.replayPrefix,\n      proxy: this.proxyPrefix,\n      api: this.apiPrefix,\n    };\n\n    this.collections = new CollectionsClass(\n      prefixes,\n      sp.get(\"root\"),\n      defaultConfig,\n    );\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.collections.loadAll(sp.get(\"dbColl\"));\n\n    this.api = new ApiClass(this.collections);\n\n    this.allowRewrittenCache = sp.get(\"allowCache\") ? true : false;\n\n    this.stats = sp.get(\"stats\") ? new StatsTracker() : null;\n\n    self.addEventListener(\"install\", () => {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      self.skipWaiting();\n    });\n\n    self.addEventListener(\"activate\", (event) => {\n      event.waitUntil(self.clients.claim());\n      console.log(\"Activate!\");\n    });\n\n    self.addEventListener(\"fetch\", (event) => {\n      event.respondWith(this.handleFetch(event));\n    });\n\n    self.addEventListener(\"message\", (event) => {\n      if (event.data.msg_type === \"reload_all\") {\n        event.waitUntil(this.collections.loadAll());\n      }\n    });\n  }\n\n  getIndexHtml(sp: URLSearchParams) {\n    const uiScript = sp.get(\"indexScript\") || \"./ui.js\";\n    const appTag = sp.get(\"indexAppTag\") || \"replay-app-main\";\n    return `\n    <!doctype html>\n    <html>\n    <head><script src=\"${uiScript}\"></script></head>\n    <body>\n    <${appTag}></${appTag}>\n    </body></html>`;\n  }\n\n  isFromReplay(request: Request) {\n    return (\n      request.url.startsWith(this.replayPrefix) ||\n      request.referrer.startsWith(this.replayPrefix)\n    );\n  }\n\n  async handleFetch(event: FetchEvent): Promise<Response> {\n    const request = event.request;\n    const url = request.url;\n\n    if (this.proxyOriginMode) {\n      if (url.startsWith(this.proxyPrefix)) {\n        return this.staticPathProxy(url, request);\n      }\n      if (!url.startsWith(this.staticPrefix)) {\n        return this.getResponseFor(request, event);\n      }\n    } else {\n      // if not on our domain, return not found\n      if (!url.startsWith(this.prefix)) {\n        if (url === \"chrome-extension://invalid/\") {\n          return notFound(request, \"Invalid URL\");\n        }\n\n        // don't allow passing through for better security\n        if (this.isFromReplay(request)) {\n          return notFound(request);\n        }\n        return this.defaultFetch(request);\n      }\n\n      // special handling when root collection set: pass through any root files, eg. /index.html\n      if (\n        this.collections.root &&\n        url.slice(this.prefix.length).indexOf(\"/\") < 0\n      ) {\n        return this.defaultFetch(request);\n      }\n\n      // JS rewrite on static/external files not from archive\n      if (url.startsWith(this.proxyPrefix)) {\n        return this.staticPathProxy(url, request);\n      }\n\n      // handle replay / api\n      if (\n        url.startsWith(this.replayPrefix) &&\n        !url.startsWith(this.staticPrefix)\n      ) {\n        return this.getResponseFor(request, event);\n      }\n    }\n\n    // current domain, but not replay, check if should cache ourselves or serve static data\n    const parsedUrl = new URL(url);\n    parsedUrl.search = \"\";\n    parsedUrl.hash = \"\";\n    const urlOnly = parsedUrl.href;\n\n    for (const staticPath of this.staticData.keys()) {\n      if (staticPath === urlOnly) {\n        const { content, type } = this.staticData.get(staticPath)!;\n        const headers = new Headers({ \"Content-Type\": type });\n        if (this.isFromReplay(request)) {\n          headers.set(\"Content-Security-Policy\", getCSP());\n        }\n        return new Response(content, { headers });\n      }\n    }\n\n    // if request is to '<origin>/newPath but referrer is from <origin>/collection/<url>/<path>,\n    // redirect to <origin>/collection/<url>/newPath\n    // correct rewriting should prevent this, but add as secondary fallback\n    if (\n      !this.topFramePassthrough &&\n      !url.startsWith(this.staticPrefix) &&\n      request.referrer.startsWith(this.replayPrefix)\n    ) {\n      const newUrl = resolveFullUrlFromReferrer(url, request.referrer);\n      if (!newUrl) {\n        return notFound(request);\n      }\n      return Response.redirect(newUrl);\n    }\n\n    // only cache: urls in the root directory (no more slashes)\n    if (\n      (parsedUrl.protocol == \"http:\" || parsedUrl.protocol == \"https:\") &&\n      parsedUrl.pathname.indexOf(\"/\", 1) < 0\n    ) {\n      return this.wrapCSPForFrame(await this.handleOffline(request), request);\n    } else {\n      return this.wrapCSPForFrame(await this.defaultFetch(request), request);\n    }\n  }\n\n  async staticPathProxy(url: string, request: Request) {\n    url = url.slice(this.proxyPrefix.length);\n\n    const urlObj = new URL(url, self.location.href);\n    url = urlObj.href;\n\n    let allowed = false;\n\n    for (const allow of proxyAllowPaths) {\n      if (url.startsWith(allow)) {\n        allowed = true;\n        break;\n      }\n    }\n\n    if (!allowed) {\n      return notFound(request);\n    }\n\n    const { method } = request;\n    // Because of CORS restrictions, the request cannot be a ReadableStream, so instead we get it as a string.\n    // If in the future we need to support streaming, we can revisit this — there may be a way to get it to work.\n    const body = method !== \"GET\" ? await request.arrayBuffer() : null;\n\n    const requestInit: RequestInit = {\n      cache: \"no-store\",\n      headers: request.headers,\n      method,\n      ...(method !== \"GET\" && { body }),\n    };\n\n    const resp = await this.defaultFetch(url, requestInit);\n\n    return this.wrapCSPForFrame(resp, request);\n  }\n\n  async wrapCSPForFrame(resp: Response, request: Request) {\n    // if target is an iframe, ensure CSP headers are added\n    // otherwise, skip as may be loading SW itself\n    if (!request.destination.endsWith(\"frame\")) {\n      return resp;\n    }\n    const { status, statusText } = resp;\n    const headers = new Headers(resp.headers);\n    headers.set(\"Content-Security-Policy\", getCSP());\n\n    return new Response(resp.body, { status, statusText, headers });\n  }\n\n  async defaultFetch(request: RequestInfo | URL, opts: RequestInit = {}) {\n    if (\n      !opts.cache &&\n      typeof request !== \"string\" &&\n      !(request instanceof URL) &&\n      request.cache === \"only-if-cached\" &&\n      request.mode !== \"same-origin\"\n    ) {\n      opts.cache = \"default\";\n    }\n    return self.fetch(request, opts);\n  }\n\n  async ensureCached(urls: string[]) {\n    const cache = await caches.open(\"wabac-offline\");\n\n    for (let url of urls) {\n      url = new URL(url, self.location.href).href;\n      let response = await cache.match(url, { ignoreSearch: true });\n      if (response) {\n        continue;\n      }\n\n      //console.log(`Auto Caching: ${url}`);\n      try {\n        response = await this.defaultFetch(new Request(url));\n        await cache.put(url, response);\n      } catch (e) {\n        console.warn(`Failed to Auto Cache: ${url}`, e);\n      }\n    }\n  }\n\n  async handleOffline(request: Request): Promise<Response> {\n    let response: Response | null | undefined = null;\n\n    const cache = await caches.open(\"wabac-offline\");\n\n    try {\n      response = await this.defaultFetch(request);\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (e) {\n      response = await cache.match(request, { ignoreSearch: true });\n      if (!response) {\n        response = notFound(\n          request,\n          \"Sorry, this url was not cached for offline use\",\n        );\n      }\n      return response;\n    }\n\n    if (request.url.startsWith(this.prefix + \"?\")) {\n      return response;\n    }\n\n    if (response.status === 200) {\n      const cacheResponse = response.clone();\n      await cache.put(request, cacheResponse);\n      //console.log(`Cached: ${request.method} ${request.url}`);\n    } else {\n      console.warn(`Not Cacheing ${request.url} - Status ${response.status}`);\n    }\n\n    return response;\n  }\n\n  async getResponseFor(request: Request, event: FetchEvent) {\n    // API\n    if (request.url.startsWith(this.apiPrefix)) {\n      if (this.stats && request.url.startsWith(this.apiPrefix + \"stats.json\")) {\n        return await this.stats.getStats(event);\n      }\n      return await this.api.apiResponse(\n        request.url.slice(this.apiPrefix.length),\n        request,\n        event,\n      );\n    }\n\n    await this.collections.inited;\n\n    const isAjax = isAjaxRequest(request);\n    const range = request.headers.get(\"range\");\n\n    try {\n      if (this.allowRewrittenCache && !range) {\n        const response = await self.caches.match(request);\n        if (response && !!response.headers.get(IS_AJAX_HEADER) === isAjax) {\n          return response;\n        }\n      }\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (e) {\n      // ignore, not cached\n    }\n\n    let collId = this.collections.root;\n\n    if (!collId) {\n      collId = request.url.slice(this.replayPrefix.length).split(\"/\", 1)[0]!;\n    }\n\n    const coll = await this.collections.getColl(collId);\n\n    // proxy origin, but no collection registered, just pass through to ensure setup is completed\n    if (!coll && (this.proxyOriginMode || this.topFramePassthrough)) {\n      return this.defaultFetch(request);\n    }\n\n    if (!coll) {\n      return notFound(request);\n    }\n\n    if (\n      !this.collections.root &&\n      !this.proxyOriginMode &&\n      !request.url.startsWith(coll.prefix)\n    ) {\n      return notFound(request);\n    }\n\n    let wbUrlStr;\n    let defaultReplayMode = false;\n\n    if (request.url.startsWith(coll.prefix) || !this.proxyOriginMode) {\n      wbUrlStr = request.url.substring(coll.prefix.length);\n      defaultReplayMode = true;\n    } else {\n      wbUrlStr = request.url;\n    }\n\n    const opts: ArchiveRequestInitOpts = {\n      isRoot: !!this.collections.root,\n      defaultReplayMode,\n    };\n\n    if (this.proxyOriginMode && !defaultReplayMode) {\n      opts.mod = \"id_\";\n      opts.proxyOrigin = coll.config.extraConfig?.proxyOrigin;\n      opts.proxyTLD = coll.config.extraConfig?.proxyTLD;\n      opts.localTLD = coll.config.extraConfig?.localTLD;\n      opts.ts = coll.config.extraConfig?.proxyTs || \"\";\n      opts.localOrigin = self.location.origin;\n    }\n\n    const archiveRequest = new ArchiveRequest(wbUrlStr, request, opts);\n\n    if (this.topFramePassthrough) {\n      if (!archiveRequest.url || !archiveRequest.mod) {\n        return this.defaultFetch(request);\n      }\n    }\n\n    if (!archiveRequest.url) {\n      return notFound(request, `Replay URL ${wbUrlStr} not found`);\n    }\n\n    const response = await coll.handleRequest(archiveRequest, event);\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (response) {\n      if (this.stats) {\n        this.stats.updateStats(\n          // [TODO]\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-argument\n          response as any,\n          response.status,\n          request,\n          event,\n        );\n      }\n\n      if (this.allowRewrittenCache && response.status === 200) {\n        try {\n          const cache = await self.caches.open(CACHE_PREFIX + coll.name);\n          if (isAjax) {\n            response.headers.set(IS_AJAX_HEADER, \"true\");\n          }\n          const cacheResp = response.clone();\n          await cache.put(request, cacheResp);\n        } catch (e) {\n          console.warn(e);\n        }\n      }\n\n      return response;\n    }\n\n    if (range) {\n      console.log(\"Not Found Range!: \" + range);\n    }\n\n    return notFound(request);\n  }\n}\n"]}