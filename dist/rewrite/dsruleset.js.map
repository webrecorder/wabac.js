{"version":3,"file":"dsruleset.js","sourceRoot":"","sources":["../../src/rewrite/dsruleset.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,WAAW,EAAE,MAAM,gBAAgB,CAAC;AAG7C,uCAAuC;AACvC,MAAM,WAAW,GAAG,OAAO,CAAC;AAO5B,8EAA8E;AAC9E,MAAM,CAAC,MAAM,aAAa,GAAY;IACpC;QACE,QAAQ,EAAE,CAAC,aAAa,EAAE,sBAAsB,CAAC;QACjD,OAAO,EAAE;YACP;gBACE,oBAAoB;gBACpB,WAAW,CACT,yEAAyE,CAC1E;aACF;YACD;gBACE,0CAA0C;gBAC1C,WAAW,CAAC,gCAAgC,CAAC;aAC9C;YACD;gBACE,6CAA6C;gBAC7C,WAAW,CAAC,6BAA6B,CAAC;aAC3C;YACD;gBACE,gCAAgC;gBAChC,WAAW,CAAC,6BAA6B,CAAC;aAC3C;YACD;gBACE,4BAA4B;gBAC5B,WAAW,CAAC,6BAA6B,CAAC;aAC3C;YACD,CAAC,2BAA2B,EAAE,WAAW,CAAC,KAAK,CAAC,CAAC;SAClD;KACF;IACD;QACE,QAAQ,EAAE,CAAC,yBAAyB,CAAC;QACrC,OAAO,EAAE,CAAC,CAAC,UAAU,EAAE,sBAAsB,CAAC,CAAC;KAChD;IACD;QACE,QAAQ,EAAE,CAAC,mCAAmC,EAAE,oBAAoB,CAAC;QACrE,OAAO,EAAE,CAAC,CAAC,UAAU,EAAE,4BAA4B,CAAC,CAAC;KACtD;IACD;QACE,QAAQ,EAAE,CAAC,eAAe,EAAE,YAAY,CAAC;QACzC,OAAO,EAAE;YACP,CAAC,4CAA4C,EAAE,iBAAiB,CAAC;YACjE,CAAC,WAAW,EAAE,cAAc,CAAC,WAAW,CAAC,CAAC;YAC1C;gBACE,kCAAkC;gBAClC,cAAc,CAAC,qBAAqB,CAAC;aACtC;YACD;gBACE,0CAA0C;gBAC1C,cAAc,CAAC,6BAA6B,CAAC;aAC9C;YACD,CAAC,+BAA+B,EAAE,cAAc,CAAC,kBAAkB,CAAC,CAAC;SACtE;KACF;IACD;QACE,QAAQ,EAAE,CAAC,gBAAgB,CAAC;QAC5B,OAAO,EAAE;YACP,CAAC,+BAA+B,EAAE,cAAc,CAAC,sBAAsB,CAAC,CAAC;YACzE;gBACE,kCAAkC;gBAClC,cAAc,CAAC,qBAAqB,CAAC;aACtC;YACD;gBACE,0CAA0C;gBAC1C,cAAc,CAAC,6BAA6B,CAAC;aAC9C;YACD,CAAC,+BAA+B,EAAE,cAAc,CAAC,kBAAkB,CAAC,CAAC;SACtE;KACF;IAED;QACE,QAAQ,EAAE;YACR,oBAAoB;YACpB,sBAAsB;YACtB,4BAA4B;YAC5B,cAAc;YACd,gBAAgB;YAChB,sBAAsB;SACvB;QACD,OAAO,EAAE;YACP,CAAC,qBAAqB,EAAE,uBAAuB,CAAC,eAAe,CAAC,CAAC;SAClE;KACF;IAED;QACE,QAAQ,EAAE,CAAC,wCAAwC,CAAC;QACpD,OAAO,EAAE;YACP,CAAC,4BAA4B,EAAE,uBAAuB,CAAC,UAAU,CAAC,CAAC;SACpE;KACF;IAED;QACE,QAAQ,EAAE,CAAC,YAAY,CAAC;QACxB,OAAO,EAAE;YACP;gBACE,qEAAqE;gBACrE,WAAW,CAAC,SAAS,CAAC;aACvB;SACF;KACF;CACF,CAAC;AAEF,MAAM,CAAC,MAAM,0BAA0B,GAAG;;+DAEqB,CAAC;AAEhE,MAAM,CAAC,MAAM,eAAe,GAAY;IACtC;QACE,QAAQ,EAAE,CAAC,aAAa,EAAE,sBAAsB,CAAC;QACjD,OAAO,EAAE,CAAC,CAAC,eAAe,EAAE,mCAAmC,EAAE,CAAC,CAAC;KACpE;IACD,GAAG,aAAa;CACjB,CAAC;AAEF,MAAM,WAAW,GAAG;IAClB;QACE,QAAQ,EAAE,kBAAkB;QAC5B,KAAK,EAAE,WAAW;QAClB,GAAG,EAAE,SAAS;KACf;CACF,CAAC;AAEF,MAAM,UAAU,eAAe,CAAC,GAAW;IACzC,IAAI,CAAC,GAAG,EAAE,CAAC;QACT,OAAO,IAAI,CAAC;IACd,CAAC;IACD,KAAK,MAAM,IAAI,IAAI,WAAW,EAAE,CAAC;QAC/B,MAAM,EAAE,QAAQ,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;QACtC,IAAI,GAAG,CAAC,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC;YACxB,OAAO,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC;QACxB,CAAC;IACH,CAAC;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAED,MAAM,UAAU,kBAAkB,CAAC,GAAW;IAC5C,MAAM,MAAM,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;IACpC,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,OAAO,IAAI,CAAC;IACd,CAAC;IACD,IAAI,CAAC;QACH,MAAM,SAAS,GAAG,IAAI,GAAG,CAAC,GAAG,CAAC,CAAC;QAC/B,IACE,CAAC,SAAS,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC;YACzC,CAAC,SAAS,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,EACvC,CAAC;YACD,OAAO,IAAI,CAAC;QACd,CAAC;QACD,SAAS,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAC5C,SAAS,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC1C,OAAO,SAAS,CAAC,IAAI,CAAC;IACxB,CAAC;IAAC,OAAO,EAAE,EAAE,CAAC;QACZ,OAAO,IAAI,CAAC;IACd,CAAC;AACH,CAAC;AAED,8DAA8D;AAC9D,MAAM,UAAU,iBAAiB,CAAC,IAAY,EAAE,IAAyB;IACvE,MAAM,SAAS,GAAG,aAAa,CAAC;IAChC,MAAM,OAAO,GAAG,OAAO,CAAC;IAExB,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;IACtC,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,KAAK,CAAC,GAAG,OAAO,CAAC,MAAM,CAAC;IAC1D,2CAA2C;IAC3C,IAAI,GAAG,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACzB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,MAAM,MAAM,GAAW,IAAI,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,GAAG,CAAC,GAAG,GAAG,CAAC,CAAC;IAEtE,IAAI,EAAE,GAAG,WAAW,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;IAEnC,EAAE,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,UAAU,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;IAEhE,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAEhE,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,GAAG,WAAW,CAAC,MAAM,CAAC,CAAC;IAC3D,OAAO,WAAW,GAAG,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AACxC,CAAC;AAED,8EAA8E;AAC9E,SAAS,WAAW,CAAC,GAAW;IAC9B,OAAO,CAAC,CAAS,EAAE,EAAE,CAAC,GAAG,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;AAC9C,CAAC;AAED,8EAA8E;AAC9E,SAAS,cAAc,CAAC,WAAmB;IACzC,OAAO,CAAC,OAAe,EAAE,EAAE;QACzB,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,OAAO,CAAC,MAAM,GAAG,WAAW,CAAC,MAAM,CAAC,CAAC;QAC9D,OAAO,WAAW,GAAG,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;IACxC,CAAC,CAAC;AACJ,CAAC;AAED,8EAA8E;AAC9E,SAAS,mCAAmC;IAC1C,OAAO,CAAC,CAAS,EAAE,EAAE,CAAC;MAClB,CAAC,WAAW,0BAA0B;GACzC,CAAC;AACJ,CAAC;AAED,8EAA8E;AAC9E,SAAS;AACT,8DAA8D;AAC9D,SAAS,aAAa,CAAC,IAAS;IAC9B,IAAI,UAAU,GAAG,WAAW,CAAC;IAC7B,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAkC,CAAC;IACzD,MAAM,SAAS,GAAG,QAAQ,EAAE,SAAS,CAAC;IAEtC,IAAI,IAAI,CAAC,IAAI,EAAE,CAAC;QACd,IAAI,CAAC,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;IACpC,CAAC;SAAM,IAAI,SAAS,EAAE,UAAU,EAAE,CAAC;QACjC,UAAU,GAAG,SAAS,CAAC,UAAU,CAAC;IACpC,CAAC;IAED,OAAO,UAAU,CAAC;AACpB,CAAC;AAED,8EAA8E;AAC9E,SAAS,uBAAuB,CAAC,MAAc;IAC7C,SAAS;IACT,8DAA8D;IAC9D,OAAO,CAAC,GAAW,EAAE,IAAyB,EAAE,EAAE;QAChD,SAAS;QACT,uEAAuE;QACvE,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,OAAO,GAAG,CAAC;QACb,CAAC;QAED,MAAM,UAAU,GAAG,GAAG,CAAC;QAEvB,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,iBAAiB,CAAC;YAEhC,MAAM,UAAU,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;YAEvC,GAAG,GAAG,GAAG,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YAE/B,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAE7B,IAAI,WAAW,GAAG,IAAI,CAAC;YACvB,IAAI,WAAW,GAAG,CAAC,CAAC;YAEpB,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACpC,IACE,CAAC,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,YAAY,KAAK,WAAW,CAAC;oBAC9D,CAAC,OAAO,CAAC,IAAI,IAAI,OAAO,CAAC,IAAI,KAAK,WAAW,CAAC,EAC9C,CAAC;oBACD,SAAS;gBACX,CAAC;gBAED,IACE,OAAO,CAAC,OAAO;oBACf,OAAO,CAAC,OAAO,GAAG,WAAW;oBAC7B,OAAO,CAAC,OAAO,IAAI,UAAU,EAC7B,CAAC;oBACD,WAAW,GAAG,OAAO,CAAC;oBACtB,WAAW,GAAG,OAAO,CAAC,OAAO,CAAC;gBAChC,CAAC;qBAAM,IAAI,OAAO,CAAC,GAAG,EAAE,CAAC;oBACvB,SAAS;oBACT,iEAAiE;oBACjE,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;oBACxC,IAAI,OAAO,EAAE,CAAC;wBACZ,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;wBACxD,IAAI,OAAO,GAAG,WAAW,EAAE,CAAC;4BAC1B,WAAW,GAAG,OAAO,CAAC;4BACtB,WAAW,GAAG,OAAO,CAAC;wBACxB,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;YAED,IAAI,WAAW,EAAE,CAAC;gBAChB,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,CAAC,CAAC;YAChC,CAAC;YAED,OAAO,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;QACvC,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,OAAO,CAAC,IAAI,CAAC,kBAAkB,EAAE,CAAC,CAAC,CAAC;YACpC,OAAO,UAAU,CAAC;QACpB,CAAC;IACH,CAAC,CAAC;AACJ,CAAC;AAED,8EAA8E;AAC9E,SAAS,sBAAsB,CAAC,GAAW;IACzC,IAAI,MAAM,CAAC;IACX,IAAI,CAAC;QACH,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACzB,SAAS;QACT,6DAA6D;IAC/D,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACX,OAAO,GAAG,CAAC;IACb,CAAC;IAED,IAAI,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC;QAC3B,MAAM,KAAK,GAAG,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC;QACnC,IAAI,OAAO,KAAK,CAAC,WAAW,KAAK,QAAQ,IAAI,KAAK,CAAC,WAAW,CAAC,MAAM,EAAE,CAAC;YACtE,IAAI,KAAK,CAAC,IAAI,EAAE,CAAC;gBACf,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC;gBAC1B,OAAO,KAAK,CAAC,IAAI,CAAC;YACpB,CAAC;YACD,IAAI,KAAK,CAAC,GAAG,EAAE,CAAC;gBACd,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,GAAG,CAAC;gBACxB,OAAO,KAAK,CAAC,GAAG,CAAC;YACnB,CAAC;YACD,OAAO,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;QAChC,CAAC;IACH,CAAC;IAED,OAAO,GAAG,CAAC,OAAO,CAAC,wBAAwB,EAAE,uBAAuB,CAAC,CAAC;AACxE,CAAC;AAED,8EAA8E;AAC9E,SAAS;AACT,8DAA8D;AAC9D,SAAS,4BAA4B,CAAC,GAAW,EAAE,IAAyB;IAC1E,SAAS;IACT,uEAAuE;IACvE,IAAI,CAAC,IAAI,EAAE,CAAC;QACV,OAAO,GAAG,CAAC;IACb,CAAC;IAED,SAAS;IACT,8DAA8D;IAC9D,IAAI,aAAa,GAAQ,IAAI,CAAC;IAE9B,MAAM,UAAU,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;IAEvC,IAAI,CAAC;QACH,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAChC,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE,aAAa,CAAC,CAAC;QACvC,SAAS;QACT,6DAA6D;IAC/D,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACX,OAAO,GAAG,CAAC;IACb,CAAC;IAED,SAAS,eAAe,CACtB,KAA+C,EAC/C,GAAW,EACX,IAAY;QAEZ,SAAS;QACT,uEAAuE;QACvE,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,OAAO,IAAI,CAAC;QACd,CAAC;QAED,IAAI,WAAW,GAAkD,IAAI,CAAC;QACtE,IAAI,WAAW,GAAG,CAAC,CAAC;QAEpB,KAAK,MAAM,OAAO,IAAI,KAAK,EAAE,CAAC;YAC5B,IACE,OAAO,CAAC,SAAS,IAAI,IAAI;gBACzB,OAAO,CAAC,OAAO,GAAG,WAAW;gBAC7B,OAAO,CAAC,OAAO,IAAI,GAAG,EACtB,CAAC;gBACD,WAAW,GAAG,OAAO,CAAC,OAAO,CAAC;gBAC9B,WAAW,GAAG,OAAO,CAAC;YACxB,CAAC;QACH,CAAC;QAED,OAAO,WAAW,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;IAC7C,CAAC;IAED,aAAa,CAAC,KAAK,GAAG,eAAe;IACnC,SAAS;IACT,iEAAiE;IACjE,aAAa,CAAC,KAAK,EACnB,UAAU,EACV,WAAW,CACZ,CAAC;IACF,aAAa,CAAC,KAAK,GAAG,eAAe;IACnC,SAAS;IACT,iEAAiE;IACjE,aAAa,CAAC,KAAK,EACnB,UAAU,EACV,WAAW,CACZ,CAAC;IAEF,OAAO,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;AACvC,CAAC;AAKD,8EAA8E;AAC9E,MAAM,OAAO,qBAAqB;IAChC,OAAO,CAAU;IACjB,WAAW,CAAI;IACf,SAAS,GAAG,IAAI,GAAG,EAAE,CAAC;IACtB,eAAe,CAAc;IAE7B,YAAY,WAAc,EAAE,OAAiB;QAC3C,IAAI,CAAC,OAAO,GAAG,OAAO,IAAI,aAAa,CAAC;QACxC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;QAE/B,IAAI,CAAC,UAAU,EAAE,CAAC;IACpB,CAAC;IAED,UAAU;QACR,IAAI,CAAC,SAAS,GAAG,IAAI,GAAG,EAAE,CAAC;QAE3B,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YAChC,SAAS;YACT,uEAAuE;YACvE,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;gBACjB,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,EAAE,IAAI,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;YAC/D,CAAC;QACH,CAAC;QACD,IAAI,CAAC,eAAe,GAAG,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;IAChD,CAAC;IAED,iBAAiB,CAAC,GAAW;QAC3B,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YAChC,SAAS;YACT,uEAAuE;YACvE,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACnB,SAAS;YACX,CAAC;YAED,KAAK,MAAM,WAAW,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACxC,IAAI,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,CAAC;oBAClC,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;oBAC1C,IAAI,QAAQ,EAAE,CAAC;wBACb,SAAS;wBACT,+DAA+D;wBAC/D,OAAO,QAAQ,CAAC;oBAClB,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED,WAAW,CAAC,GAAW;QACrB,SAAS;QACT,+DAA+D;QAC/D,OAAO,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,eAAe,CAAC;IAC7D,CAAC;CACF","sourcesContent":["import { type ArchiveResponse } from \"../response\";\nimport { rewriteDASH } from \"./rewriteVideo\";\nimport { type RxRewriter, type Rule } from \"./rxrewriter\";\n\n//import unescapeJs from \"unescape-js\";\nconst MAX_BITRATE = 5000000;\n\ntype Rules = {\n  contains: string[];\n  rxRules: Rule[];\n};\n\n// ===========================================================================\nexport const DEFAULT_RULES: Rules[] = [\n  {\n    contains: [\"youtube.com\", \"youtube-nocookie.com\"],\n    rxRules: [\n      [\n        /ytplayer.load\\(\\);/,\n        ruleReplace(\n          'ytplayer.config.args.dash = \"0\"; ytplayer.config.args.dashmpd = \"\"; {0}',\n        ),\n      ],\n      [\n        /yt\\.setConfig.*PLAYER_CONFIG.*args\":\\s*{/,\n        ruleReplace('{0} \"dash\": \"0\", dashmpd: \"\", '),\n      ],\n      [\n        /(?:\"player\":|ytplayer\\.config).*\"args\":\\s*{/,\n        ruleReplace('{0}\"dash\":\"0\",\"dashmpd\":\"\",'),\n      ],\n      [\n        /yt\\.setConfig.*PLAYER_VARS.*?{/,\n        ruleReplace('{0}\"dash\":\"0\",\"dashmpd\":\"\",'),\n      ],\n      [\n        /ytplayer.config={args:\\s*{/,\n        ruleReplace('{0}\"dash\":\"0\",\"dashmpd\":\"\",'),\n      ],\n      [/\"0\"\\s*?==\\s*?\\w+\\.dash&&/m, ruleReplace(\"1&&\")],\n    ],\n  },\n  {\n    contains: [\"player.vimeo.com/video/\"],\n    rxRules: [[/^\\{.+\\}$/, ruleRewriteVimeoConfig]],\n  },\n  {\n    contains: [\"master.json?query_string_ranges=0\", \"master.json?base64\"],\n    rxRules: [[/^\\{.+\\}$/, ruleRewriteVimeoDashManifest]],\n  },\n  {\n    contains: [\"facebook.com/\", \"fbsbx.com/\"],\n    rxRules: [\n      [/\"dash_manifests.*?,\"failure_reason\":null}]/, ruleRewriteFBDash],\n      [/\"playlist/, ruleReplacePad('\"playli__')],\n      [\n        /\"debugNoBatching\\s?\":(?:false|0)/,\n        ruleReplacePad('\"debugNoBatching\":1'),\n      ],\n      [\n        /\"bulkRouteFetchBatchSize\\s?\":(?:[^{},]+)/,\n        ruleReplacePad('\"bulkRouteFetchBatchSize\":1'),\n      ],\n      [/\"maxBatchSize\\s?\":(?:[^{},]+)/, ruleReplacePad('\"maxBatchSize\":1')],\n    ],\n  },\n  {\n    contains: [\"instagram.com/\"],\n    rxRules: [\n      [/\"is_dash_eligible\":(?:true|1)/, ruleReplacePad('\"is_dash_eligible\":0')],\n      [\n        /\"debugNoBatching\\s?\":(?:false|0)/,\n        ruleReplacePad('\"debugNoBatching\":1'),\n      ],\n      [\n        /\"bulkRouteFetchBatchSize\\s?\":(?:[^{},]+)/,\n        ruleReplacePad('\"bulkRouteFetchBatchSize\":1'),\n      ],\n      [/\"maxBatchSize\\s?\":(?:[^{},]+)/, ruleReplacePad('\"maxBatchSize\":1')],\n    ],\n  },\n\n  {\n    contains: [\n      \"api.twitter.com/2/\",\n      \"twitter.com/i/api/2/\",\n      \"twitter.com/i/api/graphql/\",\n      \"api.x.com/2/\",\n      \"x.com/i/api/2/\",\n      \"x.com/i/api/graphql/\",\n    ],\n    rxRules: [\n      [/\"video_info\":.*?}]}/, ruleRewriteTwitterVideo('\"video_info\":')],\n    ],\n  },\n\n  {\n    contains: [\"cdn.syndication.twimg.com/tweet-result\"],\n    rxRules: [\n      [/\"video\":.*?viewCount\":\\d+}/, ruleRewriteTwitterVideo('\"video\":')],\n    ],\n  },\n\n  {\n    contains: [\"/vqlweb.js\"],\n    rxRules: [\n      [\n        /\\b\\w+\\.updatePortSize\\(\\);this\\.updateApplicationSize\\(\\)(?![*])/gim,\n        ruleReplace(\"/*{0}*/\"),\n      ],\n    ],\n  },\n];\n\nexport const DISABLE_MEDIASOURCE_SCRIPT = `\\\n  ;Object.defineProperty(MediaSource, \"isTypeSupported\",\\\n  {value: () => false, configurable: false, writable: false});`;\n\nexport const HTML_ONLY_RULES: Rules[] = [\n  {\n    contains: [\"youtube.com\", \"youtube-nocookie.com\"],\n    rxRules: [[/[^\"]<head.*?>/, ruleDisableMediaSourceTypeSupported()]],\n  },\n  ...DEFAULT_RULES,\n];\n\nconst RANGE_RULES = [\n  {\n    contains: /video.*fbcdn.net/,\n    start: \"bytestart\",\n    end: \"byteend\",\n  },\n];\n\nexport function hasRangeAsQuery(url: string) {\n  if (!url) {\n    return null;\n  }\n  for (const rule of RANGE_RULES) {\n    const { contains, start, end } = rule;\n    if (url.match(contains)) {\n      return { start, end };\n    }\n  }\n\n  return null;\n}\n\nexport function removeRangeAsQuery(url: string) {\n  const result = hasRangeAsQuery(url);\n  if (!result) {\n    return null;\n  }\n  try {\n    const parsedUrl = new URL(url);\n    if (\n      !parsedUrl.searchParams.has(result.start) ||\n      !parsedUrl.searchParams.has(result.end)\n    ) {\n      return null;\n    }\n    parsedUrl.searchParams.delete(result.start);\n    parsedUrl.searchParams.delete(result.end);\n    return parsedUrl.href;\n  } catch (_e) {\n    return null;\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function ruleRewriteFBDash(text: string, opts: Record<string, any>) {\n  const START_TAG = \"\\\\u003C?xml\";\n  const END_TAG = \"/MPD>\";\n\n  const start = text.indexOf(START_TAG);\n  const end = text.indexOf(END_TAG, start) + END_TAG.length;\n  // if not found, will be END_TAG.length - 1\n  if (end < END_TAG.length) {\n    return text;\n  }\n\n  const rwtext: string = JSON.parse('\"' + text.slice(start, end) + '\"');\n\n  let rw = rewriteDASH(rwtext, opts);\n\n  rw = JSON.stringify(rw).replaceAll(\"<\", \"\\\\u003C\").slice(1, -1);\n\n  const replacement = text.slice(0, start) + rw + text.slice(end);\n\n  const diff = Math.max(0, text.length - replacement.length);\n  return replacement + \" \".repeat(diff);\n}\n\n// ===========================================================================\nfunction ruleReplace(str: string) {\n  return (x: string) => str.replace(\"{0}\", x);\n}\n\n// ===========================================================================\nfunction ruleReplacePad(replacement: string) {\n  return (matched: string) => {\n    const diff = Math.max(0, matched.length - replacement.length);\n    return replacement + \" \".repeat(diff);\n  };\n}\n\n// ===========================================================================\nfunction ruleDisableMediaSourceTypeSupported() {\n  return (x: string) => `\n    ${x}<script>${DISABLE_MEDIASOURCE_SCRIPT}</script>\n  `;\n}\n\n// ===========================================================================\n// [TODO]\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction setMaxBitrate(opts: any) {\n  let maxBitrate = MAX_BITRATE;\n  const response = opts.response as ArchiveResponse | null;\n  const extraOpts = response?.extraOpts;\n\n  if (opts.save) {\n    opts.save.maxBitrate = maxBitrate;\n  } else if (extraOpts?.maxBitrate) {\n    maxBitrate = extraOpts.maxBitrate;\n  }\n\n  return maxBitrate;\n}\n\n// ===========================================================================\nfunction ruleRewriteTwitterVideo(prefix: string) {\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  return (str: string, opts: Record<string, any>) => {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (!opts) {\n      return str;\n    }\n\n    const origString = str;\n\n    try {\n      const W_X_H = /([\\d]+)x([\\d]+)/;\n\n      const maxBitrate = setMaxBitrate(opts);\n\n      str = str.slice(prefix.length);\n\n      const data = JSON.parse(str);\n\n      let bestVariant = null;\n      let bestBitrate = 0;\n\n      for (const variant of data.variants) {\n        if (\n          (variant.content_type && variant.content_type !== \"video/mp4\") ||\n          (variant.type && variant.type !== \"video/mp4\")\n        ) {\n          continue;\n        }\n\n        if (\n          variant.bitrate &&\n          variant.bitrate > bestBitrate &&\n          variant.bitrate <= maxBitrate\n        ) {\n          bestVariant = variant;\n          bestBitrate = variant.bitrate;\n        } else if (variant.src) {\n          // [TODO]\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n          const matched = W_X_H.exec(variant.src);\n          if (matched) {\n            const bitrate = Number(matched[1]) * Number(matched[2]);\n            if (bitrate > bestBitrate) {\n              bestBitrate = bitrate;\n              bestVariant = variant;\n            }\n          }\n        }\n      }\n\n      if (bestVariant) {\n        data.variants = [bestVariant];\n      }\n\n      return prefix + JSON.stringify(data);\n    } catch (e) {\n      console.warn(\"rewriter error: \", e);\n      return origString;\n    }\n  };\n}\n\n// ===========================================================================\nfunction ruleRewriteVimeoConfig(str: string) {\n  let config;\n  try {\n    config = JSON.parse(str);\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  } catch (e) {\n    return str;\n  }\n\n  if (config?.request?.files) {\n    const files = config.request.files;\n    if (typeof files.progressive === \"object\" && files.progressive.length) {\n      if (files.dash) {\n        files.__dash = files.dash;\n        delete files.dash;\n      }\n      if (files.hls) {\n        files.__hls = files.hls;\n        delete files.hls;\n      }\n      return JSON.stringify(config);\n    }\n  }\n\n  return str.replace(/query_string_ranges=1/g, \"query_string_ranges=0\");\n}\n\n// ===========================================================================\n// [TODO]\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction ruleRewriteVimeoDashManifest(str: string, opts: Record<string, any>) {\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n  if (!opts) {\n    return str;\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let vimeoManifest: any = null;\n\n  const maxBitrate = setMaxBitrate(opts);\n\n  try {\n    vimeoManifest = JSON.parse(str);\n    console.log(\"manifest\", vimeoManifest);\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  } catch (e) {\n    return str;\n  }\n\n  function filterByBitrate(\n    array: { mime_type: string; bitrate: number }[],\n    max: number,\n    mime: string,\n  ) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (!array) {\n      return null;\n    }\n\n    let bestVariant: { mime_type: string; bitrate: number } | null = null;\n    let bestBitrate = 0;\n\n    for (const variant of array) {\n      if (\n        variant.mime_type == mime &&\n        variant.bitrate > bestBitrate &&\n        variant.bitrate <= max\n      ) {\n        bestBitrate = variant.bitrate;\n        bestVariant = variant;\n      }\n    }\n\n    return bestVariant ? [bestVariant] : array;\n  }\n\n  vimeoManifest.video = filterByBitrate(\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    vimeoManifest.video,\n    maxBitrate,\n    \"video/mp4\",\n  );\n  vimeoManifest.audio = filterByBitrate(\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    vimeoManifest.audio,\n    maxBitrate,\n    \"audio/mp4\",\n  );\n\n  return JSON.stringify(vimeoManifest);\n}\n\n// ===========================================================================\ntype T = typeof RxRewriter;\n\n// ===========================================================================\nexport class DomainSpecificRuleSet {\n  rwRules: Rules[];\n  RewriterCls: T;\n  rewriters = new Map();\n  defaultRewriter!: RxRewriter;\n\n  constructor(RewriterCls: T, rwRules?: Rules[]) {\n    this.rwRules = rwRules || DEFAULT_RULES;\n    this.RewriterCls = RewriterCls;\n\n    this._initRules();\n  }\n\n  _initRules() {\n    this.rewriters = new Map();\n\n    for (const rule of this.rwRules) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n      if (rule.rxRules) {\n        this.rewriters.set(rule, new this.RewriterCls(rule.rxRules));\n      }\n    }\n    this.defaultRewriter = new this.RewriterCls();\n  }\n\n  getCustomRewriter(url: string) {\n    for (const rule of this.rwRules) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n      if (!rule.contains) {\n        continue;\n      }\n\n      for (const containsStr of rule.contains) {\n        if (url.indexOf(containsStr) >= 0) {\n          const rewriter = this.rewriters.get(rule);\n          if (rewriter) {\n            // [TODO]\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n            return rewriter;\n          }\n        }\n      }\n    }\n\n    return null;\n  }\n\n  getRewriter(url: string) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return this.getCustomRewriter(url) || this.defaultRewriter;\n  }\n}\n"]}