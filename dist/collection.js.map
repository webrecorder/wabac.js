{"version":3,"file":"collection.js","sourceRoot":"","sources":["../src/collection.ts"],"names":[],"mappings":"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","sourcesContent":["import { ProxyRewriter, Rewriter } from \"./rewrite\";\nimport { DISABLE_MEDIASOURCE_SCRIPT } from \"./rewrite/dsruleset\";\n\nimport {\n  getTS,\n  getSecondsStr,\n  parseSetCookie,\n  handleAuthNeeded,\n  REPLAY_TOP_FRAME_NAME,\n  proxyAllowPaths,\n  getCSP,\n} from \"./utils\";\n\nimport { ArchiveResponse } from \"./response\";\n\nimport { getAdBlockCSSResponse } from \"./adblockcss\";\nimport { notFound, notFoundByTypeResponse } from \"./notfound\";\nimport { type ArchiveDB } from \"./archivedb\";\nimport { type ArchiveRequest } from \"./request\";\nimport { type CollMetadata, type CollConfig, type ExtraConfig } from \"./types\";\n\nexport type Prefixes = {\n  static: string;\n  root: string;\n  main: string;\n  proxy: string;\n  api: string;\n};\n\n// ===========================================================================\nexport class Collection {\n  name: string;\n  store: ArchiveDB;\n\n  config: CollConfig;\n  metadata: CollMetadata;\n\n  injectScripts: string[];\n\n  noRewritePrefixes: string[] | null;\n\n  noPostToGet: boolean;\n  convertPostToGet: boolean;\n\n  coHeaders: boolean;\n  csp: string;\n  injectRelCanon: boolean;\n\n  baseFramePrefix: string;\n  baseFrameUrl: string;\n  baseFrameHashReplay = false;\n  baseFrameAppendReplay = false;\n\n  liveRedirectOnNotFound = false;\n\n  rootPrefix: string;\n  isRoot: boolean;\n\n  prefix: string;\n\n  adblockUrl?: string;\n\n  staticPrefix: string;\n  proxyPrefix: string;\n\n  proxyBannerUrl = \"\";\n\n  constructor(\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    opts: Record<string, any>,\n    prefixes: Prefixes,\n    defaultConfig = {},\n  ) {\n    const { name, store, config } = opts;\n\n    this.name = name;\n    this.store = store;\n    this.config = config;\n    this.metadata = this.config.metadata ? this.config.metadata : {};\n\n    const extraConfig: ExtraConfig = {\n      ...defaultConfig,\n      ...this.config.extraConfig,\n    };\n\n    this.injectScripts = extraConfig.injectScripts || [];\n    this.noRewritePrefixes = extraConfig.noRewritePrefixes || null;\n\n    this.noPostToGet = !!extraConfig.noPostToGet;\n\n    this.convertPostToGet = !!extraConfig.convertPostToGet;\n\n    this.coHeaders = extraConfig.coHeaders || false;\n\n    this.csp = extraConfig.csp || getCSP() + this.name + \"/\";\n\n    this.injectRelCanon = extraConfig.injectRelCanon || false;\n\n    this.baseFramePrefix = extraConfig.baseUrlSourcePrefix!;\n    this.baseFrameUrl = extraConfig.baseUrl!;\n    this.baseFrameHashReplay = extraConfig.baseUrlHashReplay || false;\n    this.baseFrameAppendReplay = extraConfig.baseUrlAppendReplay || false;\n\n    this.liveRedirectOnNotFound = extraConfig.liveRedirectOnNotFound || false;\n\n    this.rootPrefix = prefixes.root || prefixes.main;\n\n    this.adblockUrl = extraConfig.adblockUrl;\n\n    this.prefix = prefixes.main;\n\n    this.proxyBannerUrl = extraConfig.proxyBannerUrl || \"\";\n    if (this.proxyBannerUrl) {\n      proxyAllowPaths.add(this.proxyBannerUrl);\n    }\n\n    // support root collection hashtag nav\n    if (this.config.root) {\n      this.isRoot = true;\n    } else {\n      this.prefix += this.name + \"/\";\n      this.isRoot = false;\n    }\n\n    this.staticPrefix = prefixes.static;\n    this.proxyPrefix = prefixes.proxy;\n  }\n\n  async handleRequest(\n    request: ArchiveRequest,\n    event: FetchEvent,\n  ): Promise<Response> {\n    // force timestamp for root coll\n    //if (!requestTS && this.isRoot) {\n    //requestTS = \"2\";\n    //}\n    let requestURL = request.url;\n    let requestTS = request.timestamp;\n\n    if (!request.mod) {\n      return await this.makeTopFrame(requestURL, requestTS);\n    }\n\n    if (!this.noPostToGet) {\n      requestURL = await request.convertPostToGet();\n    }\n\n    // exact or fuzzy match\n    let response: ArchiveResponse | Response | null = null;\n\n    let baseUrl = requestURL;\n\n    try {\n      if (requestURL.startsWith(\"srcdoc:\")) {\n        response = this.getSrcDocResponse(\n          requestURL,\n          requestURL.slice(\"srcdoc:\".length),\n        );\n      } else if (requestURL.startsWith(\"blob:\")) {\n        // the form of this url is now blob:<blob id>/<base url>\n        // split on / to separate <blob id> and <base url>\n        const inx = requestURL.indexOf(\"/\");\n        // blob url = blob:<origin>/<blob id>\n        // skip blob prefix also\n        const blobId = requestURL.slice(5, inx);\n        const blobUrl = `blob:${self.location.origin}/${blobId}`;\n        baseUrl = requestURL.slice(inx + 1);\n        response = await this.getBlobResponse(blobUrl);\n      } else if (requestURL === \"about:blank\") {\n        response = await this.getSrcDocResponse(requestURL);\n      } else if (requestURL === \"__wb_module_decl.js\") {\n        response = await this.getWrappedModuleDecl();\n      } else if (this.adblockUrl && requestURL.startsWith(\"adblock:\")) {\n        response = await getAdBlockCSSResponse(\n          requestURL.slice(\"adblock:\".length),\n          this.adblockUrl,\n        );\n      } else {\n        response = await this.getReplayResponse(request, event);\n        requestURL = request.url;\n        if (\n          response &&\n          response instanceof ArchiveResponse &&\n          response.updateTS\n        ) {\n          requestTS = response.updateTS;\n        }\n      }\n    } catch (e) {\n      if (await handleAuthNeeded(e, this.config)) {\n        return notFound(\n          request.request,\n          '<p style=\"margin: auto\">Please wait, this page will reload after authentication...</p>',\n          401,\n        );\n      }\n    }\n\n    if (!response) {\n      try {\n        requestURL = decodeURIComponent(requestURL);\n        requestURL += request.hash;\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      } catch (e) {\n        // ignore invalid URL\n      }\n\n      return notFoundByTypeResponse(\n        request.request,\n        requestURL,\n        requestTS,\n        this.liveRedirectOnNotFound,\n      );\n    } else if (response instanceof Response) {\n      // custom Response, not an ArchiveResponse, just return\n      return response;\n    }\n\n    if (!response.noRW) {\n      if (!request.isProxyOrigin) {\n        response = await this.fullRewrite(\n          request,\n          response,\n          baseUrl,\n          requestURL,\n          requestTS,\n        );\n      } else {\n        response = await this.proxyRewrite(\n          request,\n          response,\n          baseUrl,\n          requestTS,\n        );\n      }\n    }\n\n    const range = request.headers.get(\"range\");\n\n    if (range && (response.status === 200 || response.status === 206)) {\n      response.setRange(range);\n    }\n\n    const deleteDisposition =\n      request.destination === \"iframe\" || request.destination === \"document\";\n    return response.makeResponse(this.coHeaders, deleteDisposition);\n  }\n\n  async fullRewrite(\n    request: ArchiveRequest,\n    response: ArchiveResponse,\n    baseUrl: string,\n    requestURL: string,\n    requestTS: string,\n  ) {\n    const basePrefix =\n      this.prefix + (request.pageId ? `:${request.pageId}/` : \"\");\n    const basePrefixTS = basePrefix + requestTS;\n    const arResponse = response;\n\n    const headInsertFunc = (url: string) => {\n      const topUrl = basePrefixTS + (requestTS ? \"/\" : \"\") + url;\n\n      return this.makeHeadInsert(\n        url,\n        requestTS,\n        topUrl,\n        basePrefix,\n        arResponse,\n        request.referrer,\n      );\n    };\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const workerInsertFunc = (text: string, opts?: any) => {\n      if (opts?.isModule) {\n        return text;\n      }\n      return (\n        `\n      (function() { self.importScripts('${this.staticPrefix}wombatWorkers.js');\\\n          new WBWombat({'prefix': '${basePrefixTS}/', 'prefixMod': '${basePrefixTS}wkrf_/', 'originalURL': '${requestURL}'});\\\n      })();` + text\n      );\n    };\n\n    const mod = request.mod;\n\n    const noRewrite = mod === \"id_\" || mod === \"wkrf_\";\n\n    const prefix = basePrefixTS + mod + \"/\";\n\n    const rewriteOpts = {\n      baseUrl,\n      responseUrl: response.url,\n      prefix,\n      headInsertFunc,\n      workerInsertFunc,\n      urlRewrite: !noRewrite,\n      contentRewrite: !noRewrite,\n      decode: this.config.decode,\n    };\n\n    const rewriter = new Rewriter(rewriteOpts);\n\n    response = await rewriter.rewrite(response, request);\n\n    response.headers.set(\"Content-Security-Policy\", this.csp);\n\n    return response;\n  }\n\n  async proxyRewrite(\n    request: ArchiveRequest,\n    response: ArchiveResponse,\n    baseUrl: string,\n    requestTS: string,\n  ) {\n    const basePrefix =\n      this.prefix + (request.pageId ? `:${request.pageId}/` : \"\");\n\n    const timestamp = response.date.toISOString();\n\n    // default to requestTS if any, otherwise us actual ts for iframe rw\n    const basePrefixTS = basePrefix + (requestTS || getTS(timestamp));\n\n    const headInsertFunc = (url: string) => {\n      const presetCookieStr = this.getCookiePreset(\n        response,\n        request.proxyScheme,\n      );\n\n      const seconds = getSecondsStr(response.date);\n\n      const extraOpts = response.extraOpts;\n\n      const disableMSE = extraOpts?.disableMSE;\n\n      return `\n<!-- WB Insert -->\n<script>\n  const wbinfo = {};\n  wbinfo.url = \"${url}\";\n  wbinfo.request_ts = \"${requestTS}\";\n  wbinfo.timestamp = \"${timestamp}\";\n  wbinfo.proxyOrigin = \"${request.proxyOrigin || \"\"}\";\n  wbinfo.localOrigin = \"${request.localOrigin || \"\"}\";\n  wbinfo.localTLD = \"${request.localTLD || \"\"}\";\n  wbinfo.proxyTLD = \"${request.proxyTLD || \"\"}\";\n  wbinfo.prefix = \"${basePrefixTS}\";\n  wbinfo.presetCookie = ${presetCookieStr};\n  wbinfo.seconds = \"${seconds}\";\n  self.__wbinfo = wbinfo;\n</script>\n<script src=\"${this.staticPrefix}wombatProxy.js\"></script>\n${\n  this.proxyBannerUrl\n    ? `\n<script src=\"${this.proxyPrefix}${this.proxyBannerUrl}\"></script>`\n    : ``\n}\n${disableMSE ? DISABLE_MEDIASOURCE_SCRIPT : \"\"}\n<!-- End WB Insert -->\n    `;\n    };\n\n    const prefix = basePrefixTS + \"mp_/\";\n\n    const rewriteOpts = {\n      baseUrl,\n      responseUrl: response.url,\n      prefix,\n      headInsertFunc,\n      workerInsertFunc: null,\n      urlRewrite: true,\n      contentRewrite: true,\n      decode: this.config.decode,\n    };\n\n    const rewriter = new ProxyRewriter(rewriteOpts, request);\n\n    response = await rewriter.rewrite(response, request);\n\n    return response;\n  }\n\n  getCookiePreset(response: ArchiveResponse, scheme: string) {\n    let presetCookie = response.headers.get(\"x-wabac-preset-cookie\") || \"\";\n    const setCookie = response.headers.get(\"Set-Cookie\");\n    if (setCookie) {\n      presetCookie = parseSetCookie(setCookie, scheme) + \";\" + presetCookie;\n    }\n    return presetCookie ? JSON.stringify(presetCookie) : '\"\"';\n  }\n\n  getCanonRedirect(query: ArchiveRequest) {\n    // [TODO]\n    // eslint-disable-next-line prefer-const\n    let { url, timestamp, mod, referrer } = query;\n    const schemeRel = url.startsWith(\"//\");\n\n    if (schemeRel) {\n      const scheme =\n        referrer && referrer.indexOf(\"/http://\") > 0 ? \"http:\" : \"https:\";\n      url = scheme + url;\n    }\n\n    try {\n      const parsed = new URL(url);\n      if (parsed.href !== url) {\n        if (parsed.pathname === \"/\") {\n          let redirectUrl = this.prefix + timestamp + mod;\n          if (timestamp || mod) {\n            redirectUrl += \"/\";\n          }\n          redirectUrl += parsed.href;\n          return Response.redirect(redirectUrl, 301);\n          // if different due to canonical URL included, just update the URL\n        } else if ((!schemeRel && url.indexOf(\":443\")) || url.indexOf(\":80\")) {\n          query.url = parsed.href;\n        }\n      }\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (e) {\n      // ignore invalid URLs, no redirect\n    }\n\n    return null;\n  }\n\n  getWrappedModuleDecl() {\n    const string = `\n    var wrapObj = function(name) {return (self._wb_wombat && self._wb_wombat.local_init && self._wb_wombat.local_init(name)) || self[name]; };\n    if (!self.__WB_pmw) { self.__WB_pmw = function(obj) { this.__WB_source = obj; return this; } }\n\n    const window = wrapObj(\"window\");\n    const document = wrapObj(\"document\");\n    const location = wrapObj(\"location\");\n    const top = wrapObj(\"top\");\n    const parent = wrapObj(\"parent\");\n    const frames = wrapObj(\"frames\");\n    const opener = wrapObj(\"opener\");\n    const __self = wrapObj(\"self\");\n    const __globalThis = wrapObj(\"globalThis\");\n\n    export { window, document, location, top, parent, frames, opener, __self as self, __globalThis as globalThis };\n    `;\n\n    const payload = new TextEncoder().encode(string);\n\n    const status = 200;\n    const statusText = \"OK\";\n    const headers = new Headers({ \"Content-Type\": \"application/javascript\" });\n    return new Response(payload, { headers, status, statusText });\n  }\n\n  getSrcDocResponse(url: string, base64str?: string) {\n    const string = base64str\n      ? decodeURIComponent(atob(base64str))\n      : \"<html><head></head><body></body></html>\";\n    const payload = new TextEncoder().encode(string);\n\n    const status = 200;\n    const statusText = \"OK\";\n    const headers = new Headers({ \"Content-Type\": \"text/html\" });\n    const date = new Date();\n    return new ArchiveResponse({\n      payload,\n      status,\n      statusText,\n      headers,\n      url,\n      date,\n    });\n  }\n\n  async getBlobResponse(url: string) {\n    const resp = await fetch(url);\n\n    const status = resp.status;\n    const statusText = resp.statusText;\n    const headers = new Headers(resp.headers);\n    if (headers.get(\"content-type\") === \"application/xhtml+xml\") {\n      headers.set(\"content-type\", \"text/html\");\n    }\n    const date = new Date();\n    const payload = new Uint8Array(await resp.arrayBuffer());\n\n    return new ArchiveResponse({\n      payload,\n      status,\n      statusText,\n      headers,\n      url,\n      date,\n    });\n  }\n\n  async getReplayResponse(\n    query: ArchiveRequest,\n    event: FetchEvent,\n  ): Promise<Response | ArchiveResponse | null> {\n    let response: Response | ArchiveResponse | null =\n      this.getCanonRedirect(query);\n\n    if (response) {\n      return response;\n    }\n\n    const opts = { pageId: query.pageId, noRedirect: query.isProxyOrigin };\n\n    response = await this.store.getResource(query, this.prefix, event, opts);\n\n    return response;\n  }\n\n  async makeTopFrame(url: string, requestTS: string) {\n    let baseUrl = \"\";\n\n    if (this.baseFrameUrl && !this.baseFramePrefix) {\n      baseUrl = this.baseFrameUrl;\n    } else if (!this.isRoot && this.config.sourceUrl) {\n      baseUrl = this.baseFramePrefix || \"./\";\n      baseUrl += `?source=${this.config.sourceUrl}`;\n    }\n\n    if (baseUrl) {\n      if (this.baseFrameAppendReplay) {\n        baseUrl += `${requestTS}/${url}`;\n      } else if (this.baseFrameHashReplay) {\n        baseUrl += `#${requestTS}/${url}`;\n      } else {\n        const locParams = new URLSearchParams({\n          url,\n          ts: requestTS,\n          view: \"replay\",\n        });\n        baseUrl += \"#\" + locParams.toString();\n      }\n\n      return Response.redirect(baseUrl);\n    }\n\n    let content = \"\";\n\n    if (this.config.topTemplateUrl) {\n      const resp = await fetch(this.config.topTemplateUrl);\n      const topTemplate = await resp.text();\n      content = topTemplate\n        .replace(\"$URL\", url)\n        .replace(\"$TS\", requestTS)\n        .replace(\"$PREFIX\", this.prefix);\n    } else {\n      content = `\n<!DOCTYPE html>\n<html>\n<head>\n<style>\nhtml, body\n{\n  height: 100%;\n  margin: 0px;\n  padding: 0px;\n  border: 0px;\n  overflow: hidden;\n}\n\n</style>\n<script src='${this.staticPrefix}wb_frame.js'> </script>\n\n<script>\nwindow.home = \"${this.rootPrefix}\";\n</script>\n\n<script src='${this.staticPrefix}default_banner.js'> </script>\n<link rel='stylesheet' href='${this.staticPrefix}default_banner.css'/>\n\n</head>\n<body style=\"margin: 0px; padding: 0px;\">\n<div id=\"wb_iframe_div\">\n<iframe id=\"replay_iframe\" name=\"${REPLAY_TOP_FRAME_NAME}\" frameborder=\"0\" seamless=\"seamless\" scrolling=\"yes\" class=\"wb_iframe\" allow=\"autoplay; fullscreen\"></iframe>\n</div>\n<script>\n  var cframe = new ContentFrame({\"url\": \"${url}\",\n                                 \"app_prefix\": \"${this.prefix}\",\n                                 \"content_prefix\": \"${this.prefix}\",\n                                 \"request_ts\": \"${requestTS}\",\n                                 \"iframe\": \"#replay_iframe\"});\n\n</script>\n</body>\n</html>\n`;\n    }\n\n    const responseData = {\n      status: 200,\n      statusText: \"OK\",\n      headers: {\n        \"Content-Type\": \"text/html\",\n        \"Content-Security-Policy\": this.csp,\n      },\n    };\n\n    return new Response(content, responseData);\n  }\n\n  makeHeadInsert(\n    url: string,\n    requestTS: string,\n    topUrl: string,\n    prefix: string,\n    response: ArchiveResponse,\n    referrer: string,\n  ) {\n    const coll = this.name;\n\n    const date = response.date;\n    const isLive = response.isLive;\n    const extraOpts = response.extraOpts;\n\n    const seconds = getSecondsStr(date);\n\n    const timestamp = getTS(date.toISOString());\n\n    const urlParsed = new URL(url);\n\n    let scheme;\n\n    // protocol scheme (for relative urls): if not http/https, try to get actual protocol from referrer\n    if (urlParsed.protocol !== \"https:\" && urlParsed.protocol !== \"http:\") {\n      scheme = referrer && referrer.indexOf(\"/http://\") > 0 ? \"http\" : \"https\";\n    } else {\n      scheme = urlParsed.protocol.slice(0, -1);\n    }\n\n    const presetCookieStr = this.getCookiePreset(response, scheme);\n\n    const pixelRatio =\n      extraOpts && Number(extraOpts.pixelRatio) ? extraOpts.pixelRatio : 2;\n\n    const storage = extraOpts?.storage\n      ? JSON.stringify(extraOpts.storage)\n      : '\"\"';\n\n    const disableMSE = extraOpts?.disableMSE;\n\n    return `\n<!-- WB Insert -->\n${\n  this.adblockUrl\n    ? `\n<link rel='stylesheet' href=\"${prefix}mp_/adblock:${urlParsed.hostname}\"/>\n<link rel='stylesheet' href=\"${prefix}mp_/adblock:\"/>\n`\n    : \"\"\n}\n<style>\nbody {\n  font-family: inherit;\n  font-size: inherit;\n}\n</style>\n${this.injectRelCanon ? `<link rel=\"canonical\" href=\"${url}\"/>` : \"\"}\n<script>\n  wbinfo = {};\n  wbinfo.top_url = \"${topUrl}\";\n  // Fast Top-Frame Redirect\n  if (window == window.top && wbinfo.top_url) {\n    var loc = window.location.href.replace(window.location.hash, \"\");\n    loc = decodeURI(loc);\n\n    if (loc != decodeURI(wbinfo.top_url)) {\n        window.location.href = wbinfo.top_url + window.location.hash;\n    }\n  }\n  wbinfo.url = \"${url}\";\n  wbinfo.timestamp = \"${timestamp}\";\n  wbinfo.request_ts = \"${requestTS}\";\n  wbinfo.prefix = decodeURI(\"${prefix}\");\n  wbinfo.mod = \"mp_\";\n  wbinfo.is_framed = true;\n  wbinfo.is_live = ${isLive ? \"true\" : \"false\"};\n  wbinfo.coll = \"${coll}\";\n  wbinfo.proxy_magic = \"\";\n  wbinfo.static_prefix = \"${this.staticPrefix}\";\n  wbinfo.enable_auto_fetch = true;\n  wbinfo.presetCookie = ${presetCookieStr};\n  wbinfo.storage = ${storage};\n  wbinfo.isSW = true;\n  wbinfo.injectDocClose = true;\n  wbinfo.pixel_ratio = ${pixelRatio};\n  wbinfo.convert_post_to_get = ${this.convertPostToGet};\n  wbinfo.target_frame = \"${REPLAY_TOP_FRAME_NAME}\";\n</script>\n<script src='${this.staticPrefix}wombat.js'> </script>\n<script>\n  wbinfo.wombat_ts = \"${isLive ? timestamp : requestTS}\";\n  wbinfo.wombat_sec = \"${seconds}\";\n  wbinfo.wombat_scheme = \"${scheme}\";\n  wbinfo.wombat_host = \"${urlParsed.host}\";\n\n  ${\n    this.noRewritePrefixes\n      ? `\n  wbinfo.wombat_opts = {\"no_rewrite_prefixes\": ${JSON.stringify(this.noRewritePrefixes)}}`\n      : `\n  wbinfo.wombat_opts = {}\n  `\n  }\n\n  if (window && window._WBWombatInit) {\n    window._WBWombatInit(wbinfo);\n  }\n    ${disableMSE ? DISABLE_MEDIASOURCE_SCRIPT : \"\"}\n</script>\n${this.injectScripts.map((script) => `<script src='${this.proxyPrefix}${script}'> </script>`).join(\"\")}\n<!-- End WB Insert -->\n`;\n  }\n}\n"]}