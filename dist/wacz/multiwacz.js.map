{"version":3,"file":"multiwacz.js","sourceRoot":"","sources":["../../src/wacz/multiwacz.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  type LoadRecordFromSourceType,\n  OnDemandPayloadArchiveDB,\n} from \"../remotearchivedb\";\nimport { SingleRecordWARCLoader } from \"../warcloader\";\nimport { CDXLoader, CDX_COOKIE } from \"../cdxloader\";\nimport {\n  AccessDeniedError,\n  digestMessage,\n  handleAuthNeeded,\n  tsToDate,\n  getTS,\n  sleep,\n  DeleteExpiredError,\n  RangeError,\n} from \"../utils\";\nimport { type AsyncIterReader, getSurt } from \"warcio\";\nimport { LiveProxy } from \"../liveproxy\";\n\nimport { type IDBPTransaction, type IDBPDatabase } from \"idb\";\n\nimport {\n  INDEX_CDX,\n  INDEX_IDX,\n  INDEX_NOT_LOADED,\n  type IndexType,\n  NO_LOAD_WACZ,\n  WACZFile,\n  type WACZFileInitOptions,\n  type WACZFileOptions,\n  type WACZLoadSource,\n  WACZ_LEAF,\n} from \"./waczfile\";\nimport { type ADBType } from \"../archivedb\";\nimport { EXTRA_PAGES_JSON, WACZImporter } from \"./waczimporter\";\nimport {\n  type BaseLoader,\n  type BlockLoaderOpts,\n  createLoader,\n} from \"../blockloaders\";\nimport { type ArchiveResponse } from \"../response\";\nimport { type ArchiveRequest } from \"../request\";\nimport { type LoadWACZEntry } from \"./ziprangereader\";\nimport {\n  type WACZPageEntry,\n  type MultiWACZJsonSpec,\n  type PageEntry,\n  type RemoteResourceEntry,\n  type WACZCollConfig,\n} from \"../types\";\n\nconst MAX_BLOCKS = 3;\n\nconst MAX_FILE_LOAD_RETRIES = 3;\n\nconst IS_SURT = /^([\\w-]+,)*[\\w-]+(:\\d+)?,?\\)\\//;\n\nexport type IDXLine = {\n  waczname: string;\n  prefix: string;\n  filename: string;\n  offset: number;\n  length: number;\n  digest?: string;\n  loaded: boolean;\n};\n\ninterface MDBType extends ADBType {\n  ziplines: {\n    key: [string, string];\n    value: unknown;\n  };\n  waczfiles: {\n    key: string;\n    value: unknown;\n  };\n  verification: {\n    key: string;\n    value: unknown;\n  };\n}\n\n// ==========================================================================\nexport class MultiWACZ\n  extends OnDemandPayloadArchiveDB\n  implements WACZLoadSource\n{\n  config: WACZCollConfig;\n  waczfiles: Record<string, WACZFile>;\n  waczNameForHash: Record<string, string>;\n  ziploadercache: Record<string, Promise<void>>;\n  updating: Promise<void> | null;\n  rootSourceType: \"wacz\" | \"json\";\n  sourceLoader: BaseLoader | undefined;\n  externalSource: LiveProxy | null;\n  textIndex: string;\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  fuzzyUrlRules: { match: RegExp; replace: any }[];\n\n  pagesQueryUrl = \"\";\n  referrerMap = new Map<string, string>();\n  notAPage = new Set<string>();\n\n  maxFallbackLookups = 3;\n\n  totalPages?: number = undefined;\n\n  preloadResources: string[] = [];\n  seedPageWACZs: Map<string, Set<string>> = new Map<string, Set<string>>();\n\n  constructor(\n    config: WACZCollConfig,\n    sourceLoader: BaseLoader,\n    rootSourceType: \"wacz\" | \"json\" = \"wacz\",\n  ) {\n    super(config.dbname, config.noCache);\n\n    this.config = config;\n\n    this.waczfiles = {};\n    this.waczNameForHash = {};\n    this.ziploadercache = {};\n\n    this.updating = null;\n\n    this.rootSourceType = rootSourceType;\n\n    this.sourceLoader = sourceLoader;\n\n    this.externalSource = null;\n    this.fuzzyUrlRules = [];\n\n    this.textIndex = config.metadata?.textIndex || EXTRA_PAGES_JSON;\n\n    if (config.extraConfig) {\n      this.initConfig(config.extraConfig);\n    }\n\n    if (config.metadata) {\n      this.pagesQueryUrl = config.metadata.pagesQueryUrl || \"\";\n\n      if (config.metadata.preloadResources?.length) {\n        for (const { name } of config.metadata.preloadResources) {\n          this.preloadResources.push(name);\n        }\n      }\n\n      if (typeof config.metadata.totalPages === \"number\") {\n        this.totalPages = config.metadata.totalPages;\n      }\n    }\n  }\n\n  initConfig(extraConfig: NonNullable<WACZCollConfig[\"extraConfig\"]>) {\n    if (extraConfig.decodeResponses !== undefined) {\n      this.config.decode = !!extraConfig.decodeResponses;\n    }\n    if (extraConfig.hostProxy) {\n      this.externalSource = new LiveProxy(extraConfig, { hostProxyOnly: true });\n    }\n    if (extraConfig.fuzzy) {\n      for (const [matchStr, replace] of extraConfig.fuzzy) {\n        const match = new RegExp(matchStr);\n        this.fuzzyUrlRules.push({ match, replace });\n      }\n    }\n    if (extraConfig.textIndex) {\n      this.textIndex = extraConfig.textIndex;\n    }\n  }\n\n  updateHeaders(headers: Record<string, string>) {\n    if (this.sourceLoader) {\n      this.sourceLoader.headers = headers;\n    }\n\n    void this.checkUpdates().catch(() =>\n      console.warn(\"Error updating JSON even after auth update\"),\n    );\n  }\n\n  // @ts-expect-error [TODO @emma-sg] - TS2416 - Property '_initDB' in type 'MultiWACZ' is not assignable to the same property in base type 'RemoteSourceArchiveDB'.\n  override _initDB(\n    db: IDBPDatabase<MDBType>,\n    oldV: number,\n    newV: number,\n    tx: IDBPTransaction<\n      MDBType,\n      (keyof MDBType)[],\n      \"readwrite\" | \"versionchange\"\n    >,\n  ) {\n    // @ts-expect-error [TODO @emma-sg] - TS2345 - Argument of type 'IDBPDatabase<MDBType>' is not assignable to parameter of type 'IDBPDatabase<DBType>'.\n    super._initDB(db, oldV, newV, tx);\n\n    if (!oldV) {\n      db.createObjectStore(\"ziplines\", { keyPath: [\"waczname\", \"prefix\"] });\n\n      db.createObjectStore(\"waczfiles\", { keyPath: \"waczname\" });\n\n      db.createObjectStore(\"verification\", { keyPath: \"id\" });\n    }\n\n    if (oldV === 2) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      this.convertV2WACZDB(db, tx);\n    }\n\n    if (oldV === 3) {\n      db.createObjectStore(\"verification\", { keyPath: \"id\" });\n    }\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  async convertV2WACZDB(db: any, tx: any) {\n    try {\n      const ziplines = await tx.objectStore(\"ziplines\").getAll();\n      const entries = await tx.objectStore(\"zipEntries\").getAll();\n\n      db.deleteObjectStore(\"ziplines\");\n\n      db.deleteObjectStore(\"zipEntries\");\n\n      db.createObjectStore(\"ziplines\", { keyPath: [\"waczname\", \"prefix\"] });\n\n      db.createObjectStore(\"waczfiles\", { keyPath: \"waczname\" });\n\n      db.createObjectStore(\"verification\", { keyPath: \"id\" });\n\n      const waczname = this.config.loadUrl;\n\n      for (const line of ziplines) {\n        line.waczname = waczname;\n        tx.objectStore(\"ziplines\").put(line);\n      }\n\n      const indexType = ziplines.length > 0 ? INDEX_IDX : INDEX_CDX;\n      const hash = await this.computeFileHash(waczname, \"\");\n      const filedata = new WACZFile({\n        waczname,\n        hash,\n        path: waczname,\n        entries,\n        indexType,\n      });\n\n      tx.objectStore(\"waczfiles\").put(filedata.serialize());\n\n      await tx.done;\n    } catch (e) {\n      console.warn(e);\n    }\n  }\n\n  addWACZFile(file: WACZFileOptions) {\n    const waczfile = new WACZFile(file);\n    this.waczfiles[file.waczname] = waczfile;\n    this.waczNameForHash[file.hash] = file.waczname;\n    return waczfile;\n  }\n\n  override async init() {\n    await super.init();\n\n    // @ts-expect-error [TODO] - TS2345 - Argument of type '\"waczfiles\"' is not assignable to parameter of type 'StoreNames<DBType>'.\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    const fileDatas = (await this.db!.getAll(\"waczfiles\")) || [];\n\n    for (const file of fileDatas) {\n      // @ts-expect-error [TODO] - TS2345 - Argument of type '{ parent: this; } | { parent: this; url: string; ts: number; digest?: string | null | undefined; status?: number | undefined; mime?: string | undefined; respHeaders?: Record<string, string> | null | undefined; ... 15 more ...; \"req.http:cookie\"?: string | undefined; } | ... 4 more ... | { ...; }' is not assignable to parameter of type 'WACZFileOptions'.\n      this.addWACZFile({ ...file, parent: this });\n    }\n\n    for (const [key, value] of Object.entries(this.waczfiles)) {\n      value.path = value.path || key;\n\n      // nested wacz will contain '#!/'\n      const inx = value.path.lastIndexOf(\"#!/\");\n      if (inx > 0) {\n        const parentName = value.path.slice(0, inx);\n        const parent = this.waczfiles[parentName];\n        // @ts-expect-error [TODO] - TS2322 - Type 'WACZFile | undefined' is not assignable to type 'WACZLoadSource | null'.\n        value.parent = parent;\n      } else if (this.rootSourceType !== \"json\") {\n        // @ts-expect-error [TODO] - TS2322 - Type 'BaseLoader | undefined' is not assignable to type 'BaseLoader | null'.\n        value.loader = this.sourceLoader;\n      }\n    }\n  }\n\n  override async close() {\n    super.close();\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    caches.delete(\"cache:\" + this.name.slice(\"db:\".length));\n  }\n\n  async clearZipData() {\n    const stores = [\"waczfiles\", \"ziplines\"];\n\n    for (const store of stores) {\n      // @ts-expect-error [TODO] - TS2345 - Argument of type 'string' is not assignable to parameter of type 'StoreNames<DBType>'.\n      await this.db!.clear(store);\n    }\n  }\n\n  override async addVerifyData(\n    prefix = \"\",\n    id: string,\n    expected: string,\n    actual: string | null = null,\n    log = false,\n  ) {\n    let matched = false;\n\n    if (prefix) {\n      id = prefix + id;\n    }\n\n    if (actual) {\n      matched = expected === actual;\n      if (log) {\n        console.log(`verify ${id}: ${matched}`);\n      }\n    }\n    // @ts-expect-error [TODO] - TS2345 - Argument of type '\"verification\"' is not assignable to parameter of type 'StoreNames<DBType>'.\n    await this.db!.put(\"verification\", { id, expected, matched });\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  override async addVerifyDataList(prefix: string, datalist: any[]) {\n    // @ts-expect-error [TODO] - TS2769 - No overload matches this call.\n    const tx = this.db!.transaction(\"verification\", \"readwrite\");\n\n    for (const data of datalist) {\n      if (prefix) {\n        data.id = prefix + data.id;\n      }\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises, @typescript-eslint/no-unsafe-argument\n      tx.store.put(data);\n    }\n\n    try {\n      await tx.done;\n    } catch (e) {\n      console.warn(e);\n    }\n  }\n\n  override async getVerifyInfo() {\n    // @ts-expect-error [TODO] - TS2345 - Argument of type '\"verification\"' is not assignable to parameter of type 'StoreNames<DBType>'.\n    const results = await this.db!.getAll(\"verification\");\n\n    let numValid = 0;\n    let numInvalid = 0;\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const info: Record<string, any> = {};\n\n    const includeProps = [\n      \"domain\",\n      \"created\",\n      \"certFingerprint\",\n      \"software\",\n      \"datapackageHash\",\n      \"publicKey\",\n    ];\n\n    for (const res of results) {\n      // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'id' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      if (includeProps.includes(res.id)) {\n        // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'id' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'. | TS2531 - Object is possibly 'null'. | TS2339 - Property 'expected' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n        info[res.id] = res.expected;\n        // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'id' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n      } else if (res.id === \"signature\") {\n        numValid++;\n        // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'matched' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n      } else if (res.matched === true) {\n        numValid++;\n        // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'matched' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n      } else if (res.matched === false) {\n        numInvalid++;\n      }\n    }\n\n    // @ts-expect-error [TODO] - TS4111 - Property 'numInvalid' comes from an index signature, so it must be accessed with ['numInvalid'].\n    info.numInvalid = numInvalid;\n    // @ts-expect-error [TODO] - TS4111 - Property 'numValid' comes from an index signature, so it must be accessed with ['numValid'].\n    info.numValid = numValid;\n\n    return info;\n  }\n\n  async getVerifyExpected(id: string) {\n    // @ts-expect-error [TODO] - TS2345 - Argument of type '\"verification\"' is not assignable to parameter of type 'StoreNames<DBType>'.\n    const res = await this.db!.get(\"verification\", id);\n    // @ts-expect-error [TODO] - TS2339 - Property 'expected' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return res?.expected;\n  }\n\n  override async clearAll() {\n    await super.clearAll();\n\n    await this.clearZipData();\n  }\n\n  override async loadRecordFromSource(\n    cdx: RemoteResourceEntry,\n  ): LoadRecordFromSourceType {\n    const { start, length, path, wacz } = cdx.source;\n    const params = { offset: start, length, unzip: true, computeHash: true };\n    const waczname = wacz!;\n\n    const { reader, hasher } = await this.loadFileFromNamedWACZ(\n      waczname,\n      \"archive/\" + path,\n      params,\n    );\n\n    const loader = new SingleRecordWARCLoader(reader);\n\n    // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n    await this.waczfiles[waczname].save(this.db);\n\n    const remote = await loader.load();\n\n    if (cdx[CDX_COOKIE] && remote?.respHeaders) {\n      remote.respHeaders[\"x-wabac-preset-cookie\"] = cdx[CDX_COOKIE];\n    }\n\n    return { remote, hasher };\n  }\n\n  async loadIndex(waczname: string) {\n    if (!this.waczfiles[waczname]) {\n      throw new Error(\"unknown waczfile: \" + waczname);\n    }\n\n    if (!this.waczfiles[waczname].entries) {\n      await this.waczfiles[waczname].init();\n    }\n\n    if (this.waczfiles[waczname].indexType) {\n      return { indexType: this.waczfiles[waczname].indexType, isNew: false };\n    }\n\n    //const indexloaders = [];\n    let indexType = INDEX_NOT_LOADED;\n\n    // load CDX and IDX\n    for (const filename of this.waczfiles[waczname].iterContainedFiles()) {\n      if (filename.endsWith(\".cdx\") || filename.endsWith(\".cdxj\")) {\n        console.log(`Loading CDX for ${waczname}`);\n\n        await this.loadCDX(filename, waczname);\n\n        indexType = INDEX_CDX;\n      } else if (filename.endsWith(\".idx\")) {\n        // For compressed indices\n        console.log(`Loading IDX for ${waczname}`);\n\n        await this.loadIDX(filename, waczname);\n\n        indexType = INDEX_IDX;\n      }\n    }\n\n    this.waczfiles[waczname].indexType = indexType as IndexType;\n\n    await this.waczfiles[waczname].save(this.db, true);\n\n    return { indexType, isNew: true };\n  }\n\n  async loadCDX(\n    filename: string,\n    waczname: string,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    progressUpdate?: any,\n    total?: number,\n  ) {\n    const { reader, hasher } = await this.loadFileFromNamedWACZ(\n      waczname,\n      filename,\n      { computeHash: true },\n    );\n\n    const loader = new CDXLoader(reader, null, waczname, { wacz: waczname });\n\n    const res = await loader.load(this, progressUpdate, total);\n\n    if (hasher) {\n      const expected = await this.getVerifyExpected(filename);\n      if (expected) {\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises, @typescript-eslint/no-unsafe-argument\n        this.addVerifyData(waczname, filename, expected, hasher.getHash());\n      }\n    }\n\n    return res;\n  }\n\n  async loadIDX(\n    filename: string,\n    waczname: string,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    progressUpdate?: any,\n    total?: number,\n  ): Promise<void> {\n    const { reader, hasher } = await this.loadFileFromNamedWACZ(\n      waczname,\n      filename,\n      { computeHash: true },\n    );\n\n    const batch: IDXLine[] = [];\n    let defaultFilename = \"\";\n\n    // start out as non surt, if surt detected, set to false\n    let nonSurt = true;\n\n    let currOffset = 0;\n\n    for await (const line of reader.iterLines()) {\n      currOffset += line.length;\n\n      // first line\n      if (currOffset === line.length) {\n        if (line.startsWith(\"!meta\")) {\n          const inx = line.indexOf(\" {\");\n          if (inx < 0) {\n            console.warn(\"Invalid Meta Line: \" + line);\n            continue;\n          }\n\n          const indexMetadata = JSON.parse(line.slice(inx));\n\n          if (indexMetadata.filename) {\n            defaultFilename = indexMetadata.filename;\n          }\n          if (indexMetadata.format !== \"cdxj-gzip-1.0\") {\n            console.log(\n              `Unknown CDXJ format \"${indexMetadata.format}\", archive may not parse correctly`,\n            );\n          }\n          continue;\n        }\n      }\n\n      let entry: IDXLine;\n\n      if (line.indexOf(\"\\t\") > 0) {\n        const [prefix, filename, offsetStr, lengthStr] = line.split(\"\\t\");\n        const offset = Number(offsetStr);\n        const length = Number(lengthStr);\n\n        // @ts-expect-error [TODO] - TS2322 - Type 'string | undefined' is not assignable to type 'string'.\n        entry = { waczname, prefix, filename, offset, length, loaded: false };\n\n        nonSurt = false;\n      } else {\n        const inx = line.indexOf(\" {\");\n        if (inx < 0) {\n          console.log(\"Invalid Index Line: \" + line);\n          continue;\n        }\n\n        const prefix = line.slice(0, inx);\n        // [TODO]\n        // eslint-disable-next-line prefer-const\n        let { offset, length, filename, digest } = JSON.parse(line.slice(inx));\n\n        nonSurt = nonSurt && !IS_SURT.test(prefix);\n\n        filename = filename || defaultFilename;\n\n        entry = {\n          waczname,\n          prefix,\n          filename,\n          offset,\n          length,\n          digest,\n          loaded: false,\n        };\n      }\n\n      if (progressUpdate && total) {\n        progressUpdate(currOffset / total, currOffset, total);\n      }\n\n      batch.push(entry);\n    }\n\n    if (hasher) {\n      const expected = await this.getVerifyExpected(filename);\n      if (expected) {\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises, @typescript-eslint/no-unsafe-argument\n        this.addVerifyData(waczname, filename, expected, hasher.getHash());\n      }\n    }\n\n    // @ts-expect-error [TODO] - TS2769 - No overload matches this call.\n    const tx = this.db!.transaction(\"ziplines\", \"readwrite\");\n\n    for (const entry of batch) {\n      // @ts-expect-error [TODO] - TS2345 - Argument of type 'IDXLine' is not assignable to parameter of type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; } | null'.\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      tx.store.put(entry);\n    }\n\n    try {\n      await tx.done;\n    } catch (e) {\n      console.log(\"Error loading ziplines index: \", e);\n    }\n\n    // set only if nonSurt is true (defaults to false)\n    // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n    if (nonSurt && nonSurt !== this.waczfiles[waczname].nonSurt) {\n      // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n      this.waczfiles[waczname].nonSurt = nonSurt;\n      // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n      await this.waczfiles[waczname].save(this.db, true);\n    }\n  }\n\n  async loadCDXFromIDX(\n    waczname: string,\n    url: string,\n    datetime = 0,\n    isPrefix = false,\n  ) {\n    //const timestamp = datetime ? getTS(new Date(datetime).toISOString()) : \"\";\n\n    // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n    const surt = this.waczfiles[waczname].nonSurt ? url : getSurt(url);\n\n    const upperBound = isPrefix ? this.prefixUpperBound(surt) : surt + \" 9999\";\n\n    const key = IDBKeyRange.upperBound([waczname, upperBound], true);\n\n    // @ts-expect-error [TODO] - TS2769 - No overload matches this call.\n    const tx = this.db!.transaction(\"ziplines\", \"readonly\");\n\n    const values: IDXLine[] = [];\n\n    for await (const cursor of tx.store.iterate(key, \"prev\")) {\n      // restrict to specific waczname\n      // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'waczname' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n      if (cursor.value.waczname !== waczname) {\n        break;\n      }\n\n      // add to beginning as processing entries in reverse here\n      // @ts-expect-error [TODO] - TS2345 - Argument of type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; } | null' is not assignable to parameter of type 'IDXLine'.\n      values.unshift(cursor.value);\n      // @ts-expect-error [TODO] - TS2531 - Object is possibly 'null'. | TS2339 - Property 'prefix' does not exist on type 'ResourceEntry | PageEntry | DigestRefCount | (PageEntry & { size?: number | undefined; }) | { pages?: unknown[] | undefined; show?: boolean | undefined; title?: string | undefined; desc?: string | undefined; slug?: string | undefined; } | { ...; }'.\n      if (!cursor.value.prefix.split(\" \")[0].startsWith(surt)) {\n        break;\n      }\n    }\n\n    await tx.done;\n\n    const cdxloaders: Promise<void>[] = [];\n\n    if (values.length > MAX_BLOCKS && datetime) {\n      values.sort((a, b) => {\n        const ts1 = a.prefix.split(\" \")[1];\n        const ts2 = b.prefix.split(\" \")[1];\n        if (!ts1 || !ts2) {\n          return 0;\n        }\n        const diff1 = Math.abs(tsToDate(ts1).getTime() - datetime);\n        const diff2 = Math.abs(tsToDate(ts2).getTime() - datetime);\n        if (diff1 === diff2) {\n          return 0;\n        }\n        return diff1 < diff2 ? -1 : 1;\n      });\n    }\n\n    let count = 0;\n\n    for (const zipblock of values) {\n      if (zipblock.loaded) {\n        continue;\n      }\n\n      const cacheKey =\n        waczname + \":\" + zipblock.filename + \":\" + zipblock.offset;\n\n      let cachedLoad = this.ziploadercache[cacheKey];\n\n      if (!cachedLoad) {\n        cachedLoad = this.doCDXLoad(cacheKey, zipblock, waczname);\n        this.ziploadercache[cacheKey] = cachedLoad;\n      }\n      cdxloaders.push(cachedLoad);\n\n      if (++count > MAX_BLOCKS) {\n        break;\n      }\n    }\n\n    if (cdxloaders.length) {\n      await Promise.allSettled(cdxloaders);\n    }\n\n    // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n    await this.waczfiles[waczname].save(this.db);\n\n    return cdxloaders.length > 0;\n  }\n\n  async doCDXLoad(\n    cacheKey: string,\n    zipblock: IDXLine,\n    waczname: string,\n  ): Promise<void> {\n    try {\n      const filename = \"indexes/\" + zipblock.filename;\n      const params = {\n        offset: zipblock.offset,\n        length: zipblock.length,\n        unzip: true,\n        computeHash: !!zipblock.digest,\n      };\n      const { reader, hasher } = await this.loadFileFromNamedWACZ(\n        waczname,\n        filename,\n        params,\n      );\n\n      const loader = new CDXLoader(reader, null, \"\", { wacz: waczname });\n      await loader.load(this);\n\n      if (hasher) {\n        const hash = hasher.getHash();\n        const id = `${filename}:${zipblock.offset}-${zipblock.length}`;\n        await this.addVerifyData(waczname, id, zipblock.digest || \"\", hash);\n      }\n\n      zipblock.loaded = true;\n      // @ts-expect-error [TODO] - TS2345 - Argument of type '\"ziplines\"' is not assignable to parameter of type 'StoreNames<DBType>'.\n      await this.db!.put(\"ziplines\", zipblock);\n    } catch (e) {\n      if (!(await handleAuthNeeded(e, this.config))) {\n        console.warn(e);\n      }\n    } finally {\n      delete this.ziploadercache[cacheKey];\n    }\n  }\n\n  async findPageAtUrl(url: string, ts: number) {\n    const pages = await this.db!.getAllFromIndex(\"pages\", \"url\", url);\n    let currPage = null;\n    let minDiff = Number.MAX_SAFE_INTEGER;\n\n    for (const page of pages) {\n      // @ts-expect-error [TODO] - TS2362 - The left-hand side of an arithmetic operation must be of type 'any', 'number', 'bigint' or an enum type. | TS2532 - Object is possibly 'undefined'.\n      const diff = Math.abs(page.ts - ts);\n      if (diff < 1000) {\n        return page;\n      }\n      if (diff < minDiff) {\n        currPage = page;\n        minDiff = diff;\n      }\n    }\n\n    return currPage;\n  }\n\n  override async lookupUrl(\n    url: string,\n    datetime: number,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    opts: Record<string, any> = {},\n  ) {\n    try {\n      const { waczname } = opts;\n\n      let result;\n\n      if (waczname && waczname !== NO_LOAD_WACZ) {\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        result = await this.lookupUrlForWACZ(waczname, url, datetime, opts);\n      }\n\n      // @ts-expect-error [TODO] - TS4111 - Property 'noRevisits' comes from an index signature, so it must be accessed with ['noRevisits'].\n      if (result && (!opts.noRevisits || result.mime !== \"warc/revisit\")) {\n        return result;\n      }\n\n      result = await super.lookupUrl(url, datetime, opts);\n\n      return result;\n    } catch (e) {\n      console.warn(e);\n      return null;\n    }\n  }\n\n  async lookupUrlForWACZ(\n    waczname: string,\n    url: string,\n    datetime: number,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    opts: Record<string, any>,\n  ) {\n    const { indexType, isNew } = await this.loadIndex(waczname);\n\n    switch (indexType) {\n      case INDEX_IDX:\n        if (!(await this.loadCDXFromIDX(waczname, url, datetime, false))) {\n          // no new idx lines loaded\n          return null;\n        }\n        break;\n\n      case INDEX_CDX:\n        if (!isNew) {\n          return null;\n        }\n        break;\n\n      default:\n        return null;\n    }\n\n    return await super.lookupUrl(url, datetime, opts);\n  }\n\n  override async resourcesByUrlAndMime(\n    url: string,\n    ...args: [string, number, boolean, string, string]\n  ) {\n    let results = await super.resourcesByUrlAndMime(url, ...args);\n\n    if (results.length > 0) {\n      return results;\n    }\n\n    for (const waczname of Object.keys(this.waczfiles)) {\n      if (waczname && waczname !== \"local\") {\n        const { indexType, isNew } = await this.loadIndex(waczname);\n\n        switch (indexType) {\n          case INDEX_IDX:\n            if (!(await this.loadCDXFromIDX(waczname, url, 0, true))) {\n              // no new idx lines loaded\n              continue;\n            }\n            break;\n\n          case INDEX_CDX:\n            if (!isNew) {\n              continue;\n            }\n            break;\n\n          default:\n            continue;\n        }\n\n        const newRes = await super.resourcesByUrlAndMime(url, ...args);\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition, @typescript-eslint/prefer-optional-chain\n        if (newRes && newRes.length) {\n          results = results.concat(newRes);\n        }\n      }\n    }\n\n    return results;\n  }\n\n  async loadFileFromWACZ(\n    waczfile: WACZFile,\n    filename: string,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    opts: Record<string, any>,\n    numRetries = 0,\n  ): LoadWACZEntry {\n    try {\n      return await waczfile.loadFile(filename, opts);\n    } catch (e) {\n      if (numRetries <= MAX_FILE_LOAD_RETRIES && (await this.retryLoad(e))) {\n        return await this.loadFileFromWACZ(\n          waczfile,\n          filename,\n          opts,\n          numRetries + 1,\n        );\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  async loadFileFromNamedWACZ(\n    waczname: string,\n    filename: string,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    opts: Record<string, any>,\n  ): LoadWACZEntry {\n    const waczfile = this.waczfiles[waczname];\n\n    if (!waczfile) {\n      throw new Error(\"No WACZ Found for: \" + waczname);\n    }\n\n    return await this.loadFileFromWACZ(waczfile, filename, opts);\n  }\n\n  async computeFileHash(waczname: string, hash?: string): Promise<string> {\n    if (!hash) {\n      hash = await digestMessage(waczname, \"sha-256\", \"\");\n    } else if (hash.indexOf(\":\") > 0) {\n      hash = hash.split(\":\")[1];\n    }\n    // @ts-expect-error [TODO] - TS2322 - Type 'string | undefined' is not assignable to type 'string'.\n    return hash;\n  }\n\n  async addNewWACZ({\n    name,\n    hash,\n    path,\n    crawlId,\n    parent,\n    loader = null,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  }: WACZFileInitOptions & { name: string }): Promise<Record<string, any>> {\n    const waczname = name || path || \"\";\n\n    hash = await this.computeFileHash(waczname, hash);\n\n    const file = this.addWACZFile({\n      waczname,\n      hash,\n      crawlId,\n      path,\n      parent,\n      loader,\n    });\n\n    if (!this.pagesQueryUrl) {\n      await file.init();\n    }\n\n    await file.save(this.db, true);\n\n    if (!this.pagesQueryUrl) {\n      const importer = new WACZImporter(this, file, !parent);\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return await importer.load();\n    } else {\n      return {};\n    }\n  }\n\n  async loadWACZFiles(json: MultiWACZJsonSpec, parent: WACZLoadSource = this) {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const promises: Promise<any>[] = [];\n\n    const update = async (name: string, path: string) => {\n      const waczfile = this.waczfiles[name];\n      if (!waczfile) {\n        return;\n      }\n      if (!this.pagesQueryUrl) {\n        waczfile.path = path;\n      } else {\n        await waczfile.init(path);\n      }\n      await waczfile.save(this.db, true);\n    };\n\n    const files = json.resources.map((res) => {\n      const path = parent.getLoadPath(res.path);\n      const name = parent.getName(res.name);\n      const hash = res.hash;\n      const crawlId = res.crawlId;\n      return { name, hash, path, crawlId };\n    });\n\n    for (const { name, hash, path, crawlId } of files) {\n      if (!this.waczfiles[name]) {\n        promises.push(this.addNewWACZ({ name, hash, path, parent, crawlId }));\n      } else if (this.waczfiles[name].path !== path) {\n        promises.push(update(name, path));\n      }\n    }\n\n    if (promises.length) {\n      await Promise.allSettled(promises);\n    }\n\n    if (json.preloadResources?.length) {\n      for (const { name } of json.preloadResources) {\n        this.preloadResources.push(name);\n      }\n    }\n\n    if (json.initialPages?.length) {\n      await this.addInitialPages(json.initialPages);\n    }\n\n    if (typeof json.totalPages === \"number\") {\n      this.totalPages = json.totalPages;\n    }\n  }\n\n  async addInitialPages(pagesImport: WACZPageEntry[]) {\n    const pages: PageEntry[] = [];\n    for (const {\n      id,\n      url,\n      title,\n      ts,\n      mime,\n      status,\n      depth,\n      favIconUrl,\n      filename,\n      isSeed,\n      crawl_id,\n    } of pagesImport) {\n      const file = this.waczfiles[filename];\n      const waczhash = file ? file.hash : \"\";\n      pages.push({\n        id,\n        url,\n        title,\n        ts,\n        mime,\n        status,\n        depth,\n        favIconUrl,\n        wacz: filename,\n        waczhash,\n        isSeed,\n      });\n      if (isSeed) {\n        const set: Set<string> =\n          this.seedPageWACZs.get(crawl_id || \"\") || new Set<string>();\n        set.add(filename);\n        this.seedPageWACZs.set(crawl_id || \"\", set);\n      }\n    }\n\n    return await this.addPages(pages);\n  }\n\n  async getTextIndex() {\n    const headers: Record<string, string> = {\n      \"Content-Type\": \"application/ndjson\",\n    };\n\n    const keys = Object.keys(this.waczfiles);\n\n    if (this.pagesQueryUrl || !this.textIndex || !keys.length) {\n      return new Response(\"\", { headers });\n    }\n\n    if (keys.length === 1) {\n      const waczname = keys[0];\n\n      let result;\n\n      try {\n        // @ts-expect-error [TODO] - TS2345 - Argument of type 'string | undefined' is not assignable to parameter of type 'string'.\n        result = await this.loadFileFromNamedWACZ(waczname, this.textIndex, {\n          unzip: true,\n        });\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      } catch (e) {\n        return new Response(\"\", { headers });\n      }\n\n      const { reader } = result;\n\n      // @ts-expect-error [TODO] - TS2538 - Type 'undefined' cannot be used as an index type.\n      const size = this.waczfiles[waczname].getSizeOf(this.textIndex);\n\n      if (size > 0) {\n        headers[\"Content-Length\"] = \"\" + size;\n      }\n\n      return new Response(reader.getReadableStream(), { headers });\n    } else {\n      const readers: AsyncIterReader[] = [];\n\n      for (const waczname of keys) {\n        try {\n          const { reader } = await this.loadFileFromNamedWACZ(\n            waczname,\n            this.textIndex,\n            { unzip: true },\n          );\n          // [TODO]\n          // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n          if (reader) {\n            readers.push(reader);\n          }\n          // [TODO]\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        } catch (e) {\n          continue;\n        }\n      }\n\n      const rs = new ReadableStream({\n        async pull(controller) {\n          for (const reader of readers) {\n            for await (const chunk of reader) {\n              controller.enqueue(chunk);\n            }\n          }\n          controller.close();\n        },\n      });\n\n      return new Response(rs, { headers });\n    }\n  }\n\n  override async getResource(\n    request: ArchiveRequest,\n    prefix: string,\n    event: FetchEvent,\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    { pageId, noRedirect }: Record<string, any> = {},\n  ): Promise<ArchiveResponse | Response | null> {\n    await this.initing;\n\n    if (this.externalSource) {\n      const res = await this.externalSource.getResource(request, prefix);\n      if (res) {\n        return res;\n      }\n    }\n\n    const hash = pageId;\n    let waczname: string | null = null;\n\n    let resp: ArchiveResponse | Response | null = null;\n\n    if (hash) {\n      // @ts-expect-error [TODO] - TS2322 - Type 'string | undefined' is not assignable to type 'string | null'.\n      waczname = this.waczNameForHash[hash];\n      if (!waczname) {\n        return null;\n      }\n      // @ts-expect-error [TODO] - TS2345 - Argument of type '{ waczname: string; }' is not assignable to parameter of type 'Opts'.\n      resp = await super.getResource(request, prefix, event, { waczname });\n      if (resp) {\n        return resp;\n      }\n    }\n\n    const waczFilesToTry: string[] = await this.getWACZFilesToTry(\n      request,\n      waczname,\n    );\n\n    if (!waczFilesToTry.length) {\n      return null;\n    }\n\n    const foundMap = new Map<\n      number,\n      { name: string; hash?: string; resp: ArchiveResponse }\n    >();\n\n    for (const name of waczFilesToTry) {\n      const file = this.waczfiles[name];\n      if (!file) {\n        continue;\n      }\n\n      if (file.fileType !== WACZ_LEAF) {\n        continue;\n      }\n\n      // already checked this file above, don't check again\n      if (file.hash === hash) {\n        continue;\n      }\n\n      resp = await super.getResource(request, prefix, event, {\n        // @ts-expect-error [TODO] - TS2345 - Argument of type '{ waczname: string; noFuzzyCheck: true; loadFirst: boolean; }' is not assignable to parameter of type 'Opts'.\n        waczname: name,\n        noFuzzyCheck: !request.isProxyOrigin,\n      });\n      if (resp) {\n        const arResponse = resp as ArchiveResponse;\n        const ts = arResponse.date.getTime();\n        foundMap.set(ts, { name, hash: file.hash, resp: arResponse });\n      }\n    }\n\n    if (foundMap.size > 0) {\n      const requestTS = tsToDate(request.timestamp);\n      let min = -1;\n      let timestamp;\n      let foundHash;\n      let bestResponse: ArchiveResponse;\n\n      for (const ts of foundMap.keys()) {\n        const dist = Math.abs(ts - requestTS.getTime());\n        if (min < 0 || dist < min) {\n          const { name, hash, resp } = foundMap.get(ts)!;\n          waczname = name;\n          foundHash = hash;\n          timestamp = getTS(resp.date.toISOString());\n          min = dist;\n          bestResponse = resp;\n        }\n      }\n\n      if (noRedirect) {\n        return bestResponse!;\n      }\n\n      return Response.redirect(\n        `${prefix}:${foundHash}/${timestamp}mp_/${request.url}`,\n      );\n    }\n\n    if (this.fuzzyUrlRules.length) {\n      for (const { match, replace } of this.fuzzyUrlRules) {\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        const newUrl = decodeURIComponent(request.url.replace(match, replace));\n        if (newUrl && newUrl !== request.url) {\n          request.url = newUrl;\n          const res = await super.getResource(request, prefix, event);\n          if (res) {\n            return res;\n          }\n        }\n      }\n    }\n\n    return null;\n  }\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  async retryLoad(e: any) {\n    if (this.rootSourceType !== \"json\") {\n      return false;\n    }\n\n    if (e instanceof AccessDeniedError || e instanceof RangeError) {\n      try {\n        await this.checkUpdates();\n        return true;\n      } catch (_) {\n        return false;\n      }\n    } else {\n      return await handleAuthNeeded(e, this.config);\n    }\n  }\n\n  async queryPages(\n    search = \"\",\n    page = 1,\n    pageSize = 25,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  ): Promise<{ pages: Record<string, any>[]; total: number }> {\n    const params = new URLSearchParams();\n    if (search) {\n      params.set(\"search\", search);\n    }\n    params.set(\"page\", page + \"\");\n    params.set(\"pageSize\", pageSize + \"\");\n    const res = await fetch(this.pagesQueryUrl + \"?\" + params.toString(), {\n      headers: this.sourceLoader?.headers,\n    });\n    if (res.status !== 200) {\n      return { pages: [], total: 0 };\n    }\n    const json = await res.json();\n    if (!json) {\n      return { pages: [], total: 0 };\n    }\n\n    const total = json.total;\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const pages: Record<string, any>[] = json.items.map((x: any) => {\n      x.wacz = x.filename;\n      const file = this.waczfiles[x.filename];\n      if (file) {\n        x.waczhash = file.hash;\n      }\n      if (typeof x.ts === \"string\") {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        x.ts = new Date(x.ts).getTime();\n      }\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return x;\n    });\n\n    return { pages, total };\n  }\n\n  async getWACZFilesToTry(request: ArchiveRequest, waczname: string | null) {\n    let names: string[] = [];\n\n    // always try WACZ files with no pages\n    if (this.preloadResources.length) {\n      names = [...this.preloadResources];\n    }\n\n    let pageUrl;\n\n    // if top-level doc, and has page query, query for which WACZ files should be tried\n    if (\n      this.pagesQueryUrl &&\n      (request.destination === \"document\" || request.destination === \"iframe\")\n    ) {\n      pageUrl = request.url;\n      // thumbnail or other custom resource for page, lookup corresponding page url\n    } else if (this.pagesQueryUrl && request.url.startsWith(\"urn:\")) {\n      const inx = request.url.indexOf(\"http\");\n      if (inx > 0) {\n        pageUrl = request.url.slice(inx);\n      }\n    } else if (\n      request.isProxyOrigin &&\n      request.referrer &&\n      request.destination !== \"document\"\n    ) {\n      pageUrl = request.referrer;\n      this.referrerMap.set(request.url, pageUrl);\n      let topLevelPage: string | undefined = \"\";\n      while (pageUrl) {\n        topLevelPage = this.referrerMap.get(pageUrl);\n        if (topLevelPage && topLevelPage !== pageUrl) {\n          pageUrl = topLevelPage;\n        } else {\n          break;\n        }\n      }\n    }\n\n    if (pageUrl && this.pagesQueryUrl) {\n      let res = await this.getWACZFilesForPagesQuery(pageUrl);\n      if (res) {\n        names = [...names, ...res];\n        return names;\n      }\n\n      if (pageUrl.startsWith(\"https://www.\")) {\n        const url = new URL(pageUrl);\n        if (url.pathname === \"/\") {\n          url.hostname = url.hostname.replace(\"www.\", \"\");\n          res = await this.getWACZFilesForPagesQuery(url.href);\n          if (res) {\n            names = [...names, ...res];\n            return names;\n          }\n        }\n      }\n    }\n\n    // if already has a WACZ files, try others from same crawl\n    if (waczname) {\n      const file = this.waczfiles[waczname];\n      if (file?.crawlId) {\n        const res = this.seedPageWACZs.get(file.crawlId);\n        if (res) {\n          names = [...names, ...res.values()];\n          return names;\n        }\n      }\n    }\n\n    // finally, fall back to all wacz files if no other choice\n    const allFiles = Object.keys(this.waczfiles);\n    if (\n      this.maxFallbackLookups > 0 &&\n      this.rootSourceType === \"json\" &&\n      this.pagesQueryUrl\n    ) {\n      return allFiles.slice(0, this.maxFallbackLookups);\n    }\n    return allFiles;\n  }\n\n  async getWACZFilesForPagesQuery(\n    requestUrl: string,\n  ): Promise<string[] | null> {\n    const selectFiles = [];\n\n    if (!this.pagesQueryUrl) {\n      return null;\n    }\n\n    const pages = await this.getPagesByUrl(requestUrl);\n    for (const page of pages) {\n      if (page.wacz) {\n        selectFiles.push(page.wacz);\n      }\n    }\n    if (selectFiles.length) {\n      return selectFiles;\n    }\n\n    if (this.notAPage.has(requestUrl)) {\n      return null;\n    }\n\n    const params = new URLSearchParams();\n    const url = new URL(requestUrl);\n    url.hash = \"\";\n    params.set(\"url\", url.href);\n    params.set(\"pageSize\", \"25\");\n    let res = await fetch(this.pagesQueryUrl + \"?\" + params.toString(), {\n      headers: this.sourceLoader?.headers,\n    });\n    if (res.status !== 200) {\n      return null;\n    }\n    let json = await res.json();\n    if (!json?.items.length && url.search) {\n      // remove query string and try again\n      url.search = \"\";\n      params.delete(\"url\");\n      params.set(\"search\", url.href);\n      res = await fetch(this.pagesQueryUrl + \"?\" + params.toString(), {\n        headers: this.sourceLoader?.headers,\n      });\n      json = await res.json();\n    }\n    const items: { filename: string; url: string }[] = json.items;\n    for (const file of items) {\n      if (!file.url.startsWith(url.href)) {\n        break;\n      }\n      if (file.filename) {\n        selectFiles.push(file.filename);\n      }\n    }\n    if (!selectFiles.length) {\n      this.notAPage.add(requestUrl);\n      return null;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    this.addInitialPages(json.items).catch((e) =>\n      console.log(e, \"additional page add failed\"),\n    );\n\n    return selectFiles;\n  }\n\n  async checkUpdates() {\n    if (this.rootSourceType !== \"json\") {\n      return;\n    }\n\n    const doUpdate = async () => {\n      try {\n        await this.loadFromJSON();\n        return;\n      } catch (_) {\n        await sleep(500);\n      }\n\n      throw new DeleteExpiredError();\n    };\n\n    if (!this.updating) {\n      this.updating = doUpdate();\n    }\n\n    try {\n      await this.updating;\n    } finally {\n      this.updating = null;\n    }\n  }\n\n  async loadFromJSON(response: Response | null = null) {\n    if (!response) {\n      // @ts-expect-error [TODO] - TS2532 - Object is possibly 'undefined'.\n      const result = await this.sourceLoader.doInitialFetch(false, false);\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition, @typescript-eslint/prefer-optional-chain\n      response = result && result.response;\n    }\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (!response || (response.status !== 206 && response.status !== 200)) {\n      console.warn(\n        \"WACZ update failed from: \" +\n          (this.config.loadUrl || this.config.sourceUrl),\n      );\n      throw new AccessDeniedError();\n    }\n\n    const data: MultiWACZJsonSpec = await response.json();\n\n    if (data.pagesQueryUrl) {\n      this.pagesQueryUrl = data.pagesQueryUrl;\n    }\n\n    switch (data.profile) {\n      case \"data-package\":\n      case \"wacz-package\":\n      //fallthrough\n\n      default:\n        await this.loadWACZFiles(data);\n    }\n\n    return data;\n  }\n\n  getLoadPath(path: string) {\n    return new URL(path, this.config.loadUrl).href;\n  }\n\n  getName(name: string) {\n    return name;\n  }\n\n  async createLoader(opts: BlockLoaderOpts): Promise<BaseLoader> {\n    return await createLoader(opts);\n  }\n}\n"]}