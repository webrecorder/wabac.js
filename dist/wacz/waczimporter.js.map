{"version":3,"file":"waczimporter.js","sourceRoot":"","sources":["../../src/wacz/waczimporter.ts"],"names":[],"mappings":"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","sourcesContent":["import yaml from \"js-yaml\";\n\nimport { verifyWACZSignature } from \"./certutils\";\nimport { type MultiWACZ } from \"./multiwacz\";\nimport { type WACZFile } from \"./waczfile\";\nimport { type PageEntry } from \"../types\";\n\nexport const MAIN_PAGES_JSON = \"pages/pages.jsonl\";\nexport const EXTRA_PAGES_JSON = \"pages/extraPages.jsonl\";\n\nexport const DATAPACKAGE_JSON = \"datapackage.json\";\nexport const DATAPACKAGE_DIGEST_JSON = \"datapackage-digest.json\";\nconst WEBARCHIVE_YAML = \"webarchive.yaml\";\n\nconst PAGE_BATCH_SIZE = 500;\n\n// ==========================================================================\nexport class WACZImporter {\n  store: MultiWACZ;\n  file: WACZFile;\n  isRoot: boolean;\n  waczname: string;\n\n  constructor(store: MultiWACZ, file: WACZFile, isRoot = true) {\n    this.file = file;\n    this.waczname = file.waczname || \"\";\n    this.store = store;\n    this.isRoot = isRoot;\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  async loadFileFromWACZ(filename: string, opts: Record<string, any>) {\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (this.store.loadFileFromWACZ) {\n      return await this.store.loadFileFromWACZ(this.file, filename, opts);\n    } else {\n      return await this.file.loadFile(filename, opts);\n    }\n  }\n\n  async load() {\n    // process loading\n    let metadata;\n\n    let datapackageDigest = null;\n\n    if (this.file.containsFile(DATAPACKAGE_DIGEST_JSON)) {\n      datapackageDigest = await this.loadDigestData(DATAPACKAGE_DIGEST_JSON);\n    }\n\n    if (this.file.containsFile(DATAPACKAGE_JSON)) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      metadata = await this.loadPackage(DATAPACKAGE_JSON, datapackageDigest);\n    } else if (this.file.containsFile(WEBARCHIVE_YAML)) {\n      metadata = await this.loadOldPackageYAML(WEBARCHIVE_YAML);\n    }\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return metadata || {};\n  }\n\n  async loadTextFileFromWACZ(\n    filename: string,\n    expectedHash = \"\",\n  ): Promise<string> {\n    const { reader, hasher } = await this.loadFileFromWACZ(filename, {\n      computeHash: !!expectedHash,\n    });\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (!reader) {\n      return \"\";\n    }\n\n    const text = new TextDecoder().decode(await reader.readFully());\n    if (expectedHash && hasher) {\n      await this.store.addVerifyData(\n        this.waczname,\n        filename,\n        expectedHash,\n        hasher.getHash(),\n      );\n    }\n    return text;\n  }\n\n  async loadDigestData(filename: string) {\n    try {\n      const digestData = JSON.parse(await this.loadTextFileFromWACZ(filename));\n      let datapackageHash;\n\n      if (digestData.path === DATAPACKAGE_JSON && digestData.hash) {\n        datapackageHash = digestData.hash;\n      }\n\n      const store = this.store;\n      const sigPrefix = this.isRoot ? \"\" : this.waczname + \":\";\n\n      if (\n        !digestData.signedData ||\n        digestData.signedData.hash !== datapackageHash\n      ) {\n        await store.addVerifyData(sigPrefix, \"signature\", \"\");\n        return;\n      }\n\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      await store.addVerifyData(sigPrefix, \"datapackageHash\", datapackageHash);\n\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      const results = await verifyWACZSignature(digestData.signedData);\n\n      await store.addVerifyDataList(sigPrefix, results);\n\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return datapackageHash;\n    } catch (e) {\n      console.warn(e);\n    }\n  }\n\n  async loadPackage(filename: string, expectedDigest: string) {\n    const text = await this.loadTextFileFromWACZ(filename, expectedDigest);\n\n    const root = JSON.parse(text);\n\n    //todo: check\n    if (this.isRoot && root.config !== undefined) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      this.store.initConfig(root.config);\n    }\n\n    switch (root.profile) {\n      case \"data-package\":\n      case \"wacz-package\":\n      case undefined:\n      case null:\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-argument\n        return await this.loadLeafWACZPackage(root);\n\n      case \"multi-wacz-package\":\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n        return await this.loadMultiWACZPackage(root);\n\n      default:\n        throw new Error(`Unknown package profile: ${root.profile}`);\n    }\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  async loadMultiWACZPackage(root: any) {\n    this.file.markAsMultiWACZ();\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    await this.store.loadWACZFiles(root, this.file);\n\n    this.store.maxFallbackLookups = -1;\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return root;\n  }\n\n  // [TODO]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  async loadLeafWACZPackage(datapackage: Record<string, any>) {\n    // @ts-expect-error [TODO] - TS4111 - Property 'metadata' comes from an index signature, so it must be accessed with ['metadata'].\n    const metadata = datapackage.metadata || {};\n\n    let pagesHash = null;\n\n    // @ts-expect-error [TODO] - TS4111 - Property 'resources' comes from an index signature, so it must be accessed with ['resources'].\n    for (const res of datapackage.resources) {\n      if (res.path === MAIN_PAGES_JSON) {\n        pagesHash = res.hash;\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        await this.store.addVerifyData(this.waczname, res.path, res.hash);\n      } else if (res.path.endsWith(\".idx\") || res.path.endsWith(\".cdx\")) {\n        // [TODO]\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        await this.store.addVerifyData(this.waczname, res.path, res.hash);\n      }\n    }\n\n    // All Pages\n    if (this.file.containsFile(MAIN_PAGES_JSON)) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-argument\n      const pageInfo: any = await this.loadPages(MAIN_PAGES_JSON, pagesHash);\n\n      if (pageInfo.hasText) {\n        this.store.textIndex = metadata.textIndex = MAIN_PAGES_JSON;\n      }\n    }\n\n    if (this.file.containsFile(EXTRA_PAGES_JSON)) {\n      this.store.textIndex = metadata.textIndex = EXTRA_PAGES_JSON;\n    }\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return metadata;\n  }\n\n  // Old WACZ 0.1.0 Format\n  async loadOldPackageYAML(filename: string) {\n    const text = await this.loadTextFileFromWACZ(filename);\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const root: Record<string, any> = yaml.load(text) as Record<string, any>;\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const metadata: Record<string, any> = {\n      // @ts-expect-error [TODO] - TS4111 - Property 'desc' comes from an index signature, so it must be accessed with ['desc'].\n      desc: root.desc,\n      // @ts-expect-error [TODO] - TS4111 - Property 'title' comes from an index signature, so it must be accessed with ['title'].\n      title: root.title,\n    };\n\n    // @ts-expect-error [TODO] - TS4111 - Property 'textIndex' comes from an index signature, so it must be accessed with ['textIndex'].\n    if (root.textIndex) {\n      // @ts-expect-error [TODO] - TS4111 - Property 'textIndex' comes from an index signature, so it must be accessed with ['textIndex']. | TS4111 - Property 'textIndex' comes from an index signature, so it must be accessed with ['textIndex'].\n      metadata.textIndex = root.textIndex;\n      // @ts-expect-error [TODO] - TS4111 - Property 'config' comes from an index signature, so it must be accessed with ['config'].\n      if (!root.config) {\n        // @ts-expect-error [TODO] - TS4111 - Property 'config' comes from an index signature, so it must be accessed with ['config'].\n        root.config = {};\n      }\n      // @ts-expect-error [TODO] - TS4111 - Property 'config' comes from an index signature, so it must be accessed with ['config']. | TS4111 - Property 'textIndex' comes from an index signature, so it must be accessed with ['textIndex'].\n      root.config.textIndex = root.textIndex;\n    }\n\n    // @ts-expect-error [TODO] - TS4111 - Property 'config' comes from an index signature, so it must be accessed with ['config'].\n    if (this.isRoot && root.config !== undefined) {\n      // @ts-expect-error [TODO] - TS4111 - Property 'config' comes from an index signature, so it must be accessed with ['config'].\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      this.store.initConfig(root.config);\n    }\n\n    // @ts-expect-error [TODO] - TS4111 - Property 'title' comes from an index signature, so it must be accessed with ['title'].\n    if (!metadata.title) {\n      // @ts-expect-error [TODO] - TS4111 - Property 'title' comes from an index signature, so it must be accessed with ['title']. | TS2339 - Property 'sourceName' does not exist on type 'Config'.\n      metadata.title = this.store.config.sourceName;\n    }\n\n    // All pages\n    // @ts-expect-error [TODO] - TS4111 - Property 'pages' comes from an index signature, so it must be accessed with ['pages'].\n    const pages = root.pages || [];\n\n    if (pages?.length) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      await this.store.addPages(pages);\n    }\n\n    // Curated Pages\n    // @ts-expect-error [TODO] - TS4111 - Property 'pageLists' comes from an index signature, so it must be accessed with ['pageLists'].\n    const pageLists = root.pageLists || [];\n\n    if (pageLists?.length) {\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      await this.store.addCuratedPageLists(pageLists, \"pages\", \"show\");\n    }\n\n    return metadata;\n  }\n\n  async loadPages(\n    filename = MAIN_PAGES_JSON,\n    expectedHash = null, // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  ): Promise<Record<string, any>[]> {\n    const { reader, hasher } = await this.loadFileFromWACZ(filename, {\n      unzip: true,\n      computeHash: true,\n    });\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (!reader) {\n      return [];\n    }\n\n    let pageListInfo = null;\n\n    let pages: PageEntry[] = [];\n\n    for await (const textLine of reader.iterLines()) {\n      const page = JSON.parse(textLine);\n\n      if (this.waczname) {\n        page.wacz = this.waczname;\n      }\n\n      if (!pageListInfo) {\n        pageListInfo = page;\n        continue;\n      }\n\n      // [TODO]\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      pages.push(page);\n\n      if (pages.length === PAGE_BATCH_SIZE) {\n        await this.store.addPages(pages);\n        pages = [];\n      }\n    }\n\n    if (pages.length) {\n      await this.store.addPages(pages);\n    }\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (hasher && expectedHash) {\n      await this.store.addVerifyData(\n        this.waczname,\n        filename,\n        expectedHash,\n        hasher.getHash(),\n      );\n    }\n\n    // [TODO]\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return pageListInfo;\n  }\n}\n"]}